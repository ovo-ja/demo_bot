<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Triple Bounce v3 - Wait For Loss</title>
    <style>
        :root{--bg:#0a0e17;--card:#1a2235;--border:#2a3549;--text:#f1f5f9;--muted:#64748b;--green:#10b981;--red:#ef4444;--cyan:#06b6d4;--yellow:#f59e0b;--purple:#a855f7;--orange:#f97316}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);padding:10px;font-size:13px}
        .container{max-width:800px;margin:0 auto}
        
        .header{text-align:center;padding:15px;border-bottom:3px solid var(--purple);margin-bottom:15px}
        .header h1{font-size:26px;color:var(--purple);margin-bottom:5px}
        .header .subtitle{color:var(--green);font-size:12px;font-weight:600}
        
        .status-bar{display:flex;justify-content:center;align-items:center;gap:20px;padding:12px;background:var(--card);border-radius:8px;margin-bottom:15px;flex-wrap:wrap}
        .status-item{text-align:center}
        .status-item .label{font-size:9px;color:var(--muted);text-transform:uppercase}
        .status-item .value{font-size:16px;font-weight:700;font-family:monospace}
        .dot{width:12px;height:12px;border-radius:50%;background:var(--muted);display:inline-block}
        .dot.on{background:var(--green);box-shadow:0 0 10px var(--green)}
        
        .card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:15px;margin-bottom:12px}
        .card h3{font-size:11px;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}
        .card.highlight{border:2px solid var(--purple);background:rgba(168,85,247,0.08)}
        
        .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
        
        label{display:block;font-size:10px;color:var(--muted);margin-bottom:3px}
        input,select{width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:12px}
        
        button{padding:12px 15px;border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:12px;text-transform:uppercase;transition:all 0.2s}
        .btn-blue{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;width:100%}
        .btn-green{background:var(--green);color:white}
        .btn-red{background:var(--red);color:white}
        .btn-purple{background:var(--purple);color:white}
        
        .digit-display{text-align:center;padding:20px;background:var(--bg);border-radius:10px;margin:15px 0}
        .current-digit{font-size:72px;font-weight:900;line-height:1;transition:all 0.2s}
        .streak-indicator{font-size:20px;margin-top:10px;font-weight:600}
        .streak-indicator.triple{color:var(--purple);animation:pulse 0.5s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        
        .digit-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin:10px 0}
        .digit-box{background:var(--bg);border:2px solid var(--border);border-radius:8px;padding:10px 5px;text-align:center;transition:all 0.2s}
        .digit-box.active{border-color:var(--yellow);background:rgba(245,158,11,0.2)}
        .digit-box.tripled{border-color:var(--purple);background:rgba(168,85,247,0.4);animation:glow 0.5s infinite}
        @keyframes glow{0%,100%{box-shadow:0 0 5px var(--purple)}50%{box-shadow:0 0 25px var(--purple)}}
        .digit-num{font-size:22px;font-weight:700}
        .digit-freq{font-size:10px;color:var(--muted)}
        
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
        .stat{background:var(--bg);padding:12px;border-radius:6px;text-align:center}
        .stat-val{font-size:20px;font-weight:700;font-family:monospace}
        .stat-val.green{color:var(--green)}
        .stat-val.red{color:var(--red)}
        .stat-label{font-size:9px;color:var(--muted);text-transform:uppercase;margin-top:3px}
        
        .win-streak-banner{background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(168,85,247,0.2));border:2px solid var(--green);border-radius:10px;padding:20px;text-align:center;margin:15px 0}
        .win-streak-banner .number{font-size:52px;font-weight:900;color:var(--green);text-shadow:0 0 20px var(--green)}
        .win-streak-banner .label{font-size:12px;color:var(--muted)}
        
        .trade-log{max-height:250px;overflow-y:auto;background:var(--bg);border-radius:6px;padding:8px}
        .trade-entry{display:flex;justify-content:space-between;padding:10px;margin-bottom:4px;border-radius:5px;font-size:11px;border-left:4px solid var(--border)}
        .trade-entry.win{border-left-color:var(--green);background:rgba(16,185,129,0.1)}
        .trade-entry.loss{border-left-color:var(--red);background:rgba(239,68,68,0.1)}
        .trade-entry.pending{border-left-color:var(--yellow);background:rgba(245,158,11,0.1)}
        
        .signal-box{padding:15px;border-radius:8px;text-align:center;font-weight:700;font-size:14px;margin:10px 0}
        .signal-box.waiting{background:rgba(100,116,139,0.2);border:2px solid var(--muted);color:var(--muted)}
        .signal-box.ready{background:rgba(168,85,247,0.2);border:2px solid var(--purple);color:var(--purple);animation:pulse 1s infinite}
        .signal-box.trading{background:rgba(16,185,129,0.2);border:2px solid var(--green);color:var(--green)}
        
        .strategy-box{background:rgba(16,185,129,0.1);border:2px solid var(--green);border-radius:8px;padding:15px;margin-bottom:15px}
        .strategy-box h4{color:var(--green);margin-bottom:10px;font-size:14px}
        .strategy-box .point{display:flex;gap:8px;margin-bottom:8px;font-size:11px}
        .strategy-box .point .icon{font-size:14px}
        .strategy-box .highlight{color:var(--cyan);font-weight:600}
        
        .activity-log{max-height:120px;overflow-y:auto;font-family:monospace;font-size:10px;background:var(--bg);padding:8px;border-radius:6px}
        .activity-log div{padding:2px 0;border-bottom:1px solid var(--border)}
        .activity-log .win{color:var(--green)}
        .activity-log .loss{color:var(--red)}
        .activity-log .info{color:var(--cyan)}
        .activity-log .alert{color:var(--yellow)}
        .activity-log .trade{color:var(--purple);font-weight:bold}
        
        .warning-box{background:rgba(239,68,68,0.1);border:1px solid var(--red);border-radius:6px;padding:10px;margin:10px 0;font-size:10px;color:var(--red)}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéØ Triple Bounce v3</h1>
        <div class="subtitle">üëÅÔ∏è Wait For Loss | Then Trade 6 | DIFFERS Only</div>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <div class="label">Status</div>
            <div class="value"><span class="dot" id="dot"></span> <span id="status">Offline</span></div>
        </div>
        <div class="status-item">
            <div class="label">Balance</div>
            <div class="value" id="balance" style="color:var(--green)">$0.00</div>
        </div>
        <div class="status-item">
            <div class="label">Time</div>
            <div class="value" id="time">--:--:--</div>
        </div>
        <div class="status-item">
            <div class="label">Market</div>
            <div class="value" id="marketDisplay">--</div>
        </div>
        <div class="status-item">
            <div class="label">Ticks</div>
            <div class="value" id="tickCount">0</div>
        </div>
    </div>
    
    <!-- Connection -->
    <div class="card">
        <h3>üîå Connection</h3>
        <div class="row">
            <div>
                <label>API Token</label>
                <input type="password" id="token" placeholder="Enter your Deriv API token">
            </div>
            <div>
                <label>Symbol</label>
                <select id="symbol">
                    <option value="1HZ10V" selected>Volatility 10 (1s)</option>
                    <option value="1HZ25V">Volatility 25 (1s)</option>
                    <option value="1HZ50V">Volatility 50 (1s)</option>
                    <option value="1HZ75V">Volatility 75 (1s)</option>
                    <option value="1HZ100V">Volatility 100 (1s)</option>
                </select>
            </div>
        </div>
        <div style="margin-top:10px">
            <button class="btn-blue" onclick="connect()">üîó Connect to Deriv</button>
        </div>
    </div>
    
    <!-- Strategy Explanation -->
    <div class="strategy-box">
        <h4>üìã Wait-For-Loss Strategy</h4>
        <div class="point">
            <span class="icon">üëÅÔ∏è</span>
            <span><strong>PHASE 1:</strong> OBSERVE triples without trading. Wait until we see a QUAD (loss).</span>
        </div>
        <div class="point">
            <span class="icon">üí•</span>
            <span><strong>TRIGGER:</strong> When a triple becomes a QUAD ‚Üí "loss is out of the way"</span>
        </div>
        <div class="point">
            <span class="icon">üéØ</span>
            <span><strong>PHASE 2:</strong> Trade the NEXT 6 triples with DIFFERS, then STOP.</span>
        </div>
        <div class="point">
            <span class="icon">‚úÖ</span>
            <span class="highlight">Theory: After a quad, next 6 triples are less likely to quad again!</span>
        </div>
    </div>
    
    <!-- Digit Display -->
    <div class="card highlight">
        <div class="digit-display">
            <div id="priceDisplay" style="font-size:13px;color:var(--muted);margin-bottom:5px">Price: -.-----</div>
            <div class="current-digit" id="currentDigit" style="color:var(--yellow)">-</div>
            <div class="streak-indicator" id="streakIndicator">Waiting for data...</div>
        </div>
        
        <div class="digit-grid" id="digitGrid"></div>
        
        <div id="signalBox" class="signal-box waiting">
            ‚è≥ WAITING FOR TRIPLE
        </div>
        
        <div id="phaseDisplay" style="text-align:center;padding:10px;background:var(--bg);border-radius:6px;margin-top:10px;font-size:12px;font-weight:600">
            <span style="color:var(--muted)">Start bot to begin</span>
        </div>
    </div>
    
    <!-- Settings -->
    <div class="card">
        <h3>‚öôÔ∏è Settings</h3>
        <div class="row3">
            <div>
                <label>Stake ($)</label>
                <input type="number" id="stake" value="1" min="0.35" step="0.01">
            </div>
            <div>
                <label>Max Freq % (filter)</label>
                <input type="number" id="maxFreq" value="16" min="12" max="20" step="1">
            </div>
            <div>
                <label>Ticks to Analyze</label>
                <input type="number" id="ticksToAnalyze" value="100" min="50" max="200">
            </div>
        </div>
        
        <div class="row" style="margin-top:10px">
            <div>
                <label>Win Target (0=unlimited)</label>
                <input type="number" id="winTarget" value="20" min="0">
            </div>
            <div>
                <label>Max Trades (0=unlimited)</label>
                <input type="number" id="maxTrades" value="30" min="0">
            </div>
        </div>
        
        <div style="margin-top:10px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" id="stopOnLoss" style="width:auto">
                <span>Stop on first loss (conservative mode)</span>
            </label>
        </div>
        
        <div class="row" style="margin-top:12px">
            <button class="btn-green" onclick="startBot()" id="startBtn">‚ñ∂Ô∏è START BOT</button>
            <button class="btn-red" onclick="stopBot()" id="stopBtn">‚èπ STOP BOT</button>
        </div>
    </div>
    
    <!-- Win Streak -->
    <div class="win-streak-banner">
        <div class="number" id="winStreak">0</div>
        <div class="label">üî• WIN STREAK</div>
    </div>
    
    <!-- Stats -->
    <div class="card">
        <h3>üìä Session Statistics</h3>
        <div class="stats-grid">
            <div class="stat">
                <div class="stat-val" id="totalTrades">0</div>
                <div class="stat-label">Trades</div>
            </div>
            <div class="stat">
                <div class="stat-val green" id="wins">0</div>
                <div class="stat-label">Wins</div>
            </div>
            <div class="stat">
                <div class="stat-val" id="winRate">0%</div>
                <div class="stat-label">Win Rate</div>
            </div>
            <div class="stat">
                <div class="stat-val green" id="pnl">$0.00</div>
                <div class="stat-label">P/L</div>
            </div>
        </div>
        <div class="row" style="margin-top:10px">
            <div class="stat">
                <div class="stat-val" id="triplesDetected">0</div>
                <div class="stat-label">Triples Seen</div>
            </div>
            <div class="stat">
                <div class="stat-val" id="triplesSkipped">0</div>
                <div class="stat-label">Skipped (Hot)</div>
            </div>
        </div>
    </div>
    
    <!-- Trade Log -->
    <div class="card">
        <h3>üí∞ Trade History <span id="tradeCount" style="float:right;color:var(--green)">0</span></h3>
        <div class="trade-log" id="tradeLog">
            <div style="text-align:center;color:var(--muted);padding:20px">No trades yet. Start the bot!</div>
        </div>
    </div>
    
    <!-- Activity Log -->
    <div class="card">
        <h3>üìã Activity Log</h3>
        <div class="activity-log" id="activityLog"></div>
    </div>
    
    <!-- Export -->
    <div class="card">
        <h3>üì• Export Data</h3>
        <div class="row">
            <button class="btn-purple" onclick="exportTrades()">Export Trades CSV</button>
            <button class="btn-purple" onclick="exportActivity()">Export Activity Log</button>
        </div>
    </div>
</div>

<script>
const state = {
    ws: null,
    connected: false,
    isTrading: false,
    pingInterval: null,
    reconnectAttempts: 0,
    
    ticks: [],
    recentDigits: [],
    frequencies: Array(10).fill(10),
    currentStreak: 1,
    lastDigit: null,
    
    pendingTrade: null,
    pendingContracts: new Map(),
    
    // NEW: Wait for Loss logic
    observationPhase: true,        // Start in observation mode
    observedTriple: null,          // Track triple we're observing
    observedQuads: 0,              // How many quads (losses) we've seen
    tradesAfterLoss: 0,            // Trades made after seeing loss
    
    totalTrades: 0,
    wins: 0,
    losses: 0,
    pnl: 0,
    winStreak: 0,
    bestStreak: 0,
    triplesDetected: 0,
    triplesSkipped: 0,
    
    tradeLog: [],
    activityLog: []
};

function initDigitGrid() {
    const grid = document.getElementById('digitGrid');
    grid.innerHTML = '';
    for (let i = 0; i < 10; i++) {
        const box = document.createElement('div');
        box.className = 'digit-box';
        box.id = `digit-${i}`;
        box.innerHTML = `<div class="digit-num">${i}</div><div class="digit-freq" id="freq-${i}">10.0%</div>`;
        grid.appendChild(box);
    }
}
initDigitGrid();

setInterval(() => {
    document.getElementById('time').textContent = new Date().toLocaleTimeString('en-US', { hour12: true });
}, 1000);

function log(msg, type = 'info') {
    const time = new Date().toLocaleTimeString('en-US', { hour12: false });
    const el = document.getElementById('activityLog');
    el.innerHTML = `<div class="${type}">[${time}] ${msg}</div>` + el.innerHTML;
    if (el.children.length > 100) el.removeChild(el.lastChild);
    state.activityLog.push({ time, message: msg, type });
}

function connect() {
    const token = document.getElementById('token').value;
    if (!token) return log('Please enter API token', 'alert');
    
    if (state.ws && state.ws.readyState === WebSocket.OPEN) state.ws.close();
    
    log('Connecting...', 'info');
    document.getElementById('status').textContent = 'Connecting...';
    state.ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
    
    state.ws.onopen = () => {
        state.ws.send(JSON.stringify({ authorize: token }));
        if (state.pingInterval) clearInterval(state.pingInterval);
        state.pingInterval = setInterval(() => {
            if (state.ws?.readyState === WebSocket.OPEN) state.ws.send(JSON.stringify({ ping: 1 }));
        }, 25000);
        state.reconnectAttempts = 0;
    };
    
    state.ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.ping || data.pong) return;
        
        if (data.authorize) {
            state.connected = true;
            document.getElementById('dot').classList.add('on');
            document.getElementById('status').textContent = 'Connected';
            document.getElementById('balance').textContent = '$' + parseFloat(data.authorize.balance).toFixed(2);
            log('‚úÖ Connected!', 'win');
            subscribeTicks();
        }
        
        if (data.tick) processTick(data.tick);
        if (data.buy) handleBuyResponse(data);
        if (data.proposal_open_contract) handleContractUpdate(data.proposal_open_contract);
        if (data.balance) document.getElementById('balance').textContent = '$' + parseFloat(data.balance.balance).toFixed(2);
    };
    
    state.ws.onclose = () => {
        state.connected = false;
        document.getElementById('dot').classList.remove('on');
        document.getElementById('status').textContent = 'Disconnected';
        if (state.pingInterval) { clearInterval(state.pingInterval); state.pingInterval = null; }
        log('üî¥ Disconnected', 'loss');
        
        if (state.isTrading && state.reconnectAttempts < 5) {
            state.reconnectAttempts++;
            log(`üîÑ Reconnecting (${state.reconnectAttempts}/5)...`, 'alert');
            setTimeout(() => { if (!state.connected) connect(); }, 3000);
        }
    };
    
    state.ws.onerror = () => log('Connection error', 'loss');
}

function subscribeTicks() {
    const symbol = document.getElementById('symbol').value;
    state.ws.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
    state.ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
    state.ws.send(JSON.stringify({ proposal_open_contract: 1, subscribe: 1 }));
    document.getElementById('marketDisplay').textContent = symbol;
    log(`üì° Subscribed to ${symbol}`, 'info');
}

function processTick(tick) {
    const price = parseFloat(tick.quote);
    const digit = parseInt(tick.quote.toString().slice(-1));
    
    state.ticks.push({ price, digit, epoch: tick.epoch });
    if (state.ticks.length > 500) state.ticks.shift();
    
    state.recentDigits.push(digit);
    if (state.recentDigits.length > 200) state.recentDigits.shift();
    
    const ticksToAnalyze = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    const recent = state.recentDigits.slice(-ticksToAnalyze);
    const counts = Array(10).fill(0);
    recent.forEach(d => counts[d]++);
    state.frequencies = counts.map(c => (c / recent.length) * 100);
    
    let streak = 1;
    for (let i = state.recentDigits.length - 2; i >= 0; i--) {
        if (state.recentDigits[i] === digit) streak++;
        else break;
    }
    state.currentStreak = streak;
    state.lastDigit = digit;
    
    updateUI(digit, price, streak >= 3);
    
    // === Check observation result ===
    if (state.isTrading && state.observationPhase && state.observedTriple) {
        checkObservationResult(digit);
    }
    
    if (state.isTrading && !state.pendingTrade) {
        checkForTriple(digit, streak);
    }
}

function checkObservationResult(currentDigit) {
    const observed = state.observedTriple;
    
    // Check if the triple we were observing just got resolved
    // (current digit is different from the observed triple digit = streak broken)
    if (currentDigit === observed.digit) {
        // Streak continues - could be quad, quint, etc.
        // Check if it's now a QUAD (4+)
        if (state.currentStreak >= 4) {
            // This WOULD have been a LOSS!
            log(`üí• QUAD DETECTED! D${observed.digit} x4 - THIS WOULD HAVE BEEN A LOSS!`, 'loss');
            log(`‚úÖ Observation complete! Now entering TRADING phase (6 trades)`, 'win');
            
            state.observationPhase = false;
            state.observedTriple = null;
            state.tradesAfterLoss = 0;
            
            document.getElementById('signalBox').className = 'signal-box ready';
            document.getElementById('signalBox').textContent = 'üéØ ARMED! Waiting for next triple...';
            updatePhaseDisplay();
        }
    } else {
        // Different digit - streak broken, the observed triple did NOT become quad
        // This would have been a WIN, but we don't care - we need to see a LOSS first
        log(`üëÅÔ∏è Observed D${observed.digit} triple ‚Üí D${currentDigit} (would have been WIN, still waiting for loss)`, 'info');
        state.observedTriple = null; // Clear, wait for next triple
    }
}

function updateUI(digit, price, isTriple) {
    document.getElementById('priceDisplay').textContent = `Price: ${price.toFixed(5)}`;
    document.getElementById('currentDigit').textContent = digit;
    document.getElementById('currentDigit').style.color = isTriple ? 'var(--purple)' : 'var(--yellow)';
    document.getElementById('tickCount').textContent = state.ticks.length;
    
    const streakEl = document.getElementById('streakIndicator');
    if (isTriple) {
        streakEl.textContent = `üî• TRIPLE! (${state.currentStreak}x D${digit})`;
        streakEl.className = 'streak-indicator triple';
    } else if (state.currentStreak === 2) {
        streakEl.textContent = `‚ö° Double (2x D${digit})`;
        streakEl.className = 'streak-indicator';
        streakEl.style.color = 'var(--orange)';
    } else {
        streakEl.textContent = `Single (D${digit})`;
        streakEl.className = 'streak-indicator';
        streakEl.style.color = 'var(--muted)';
    }
    
    for (let i = 0; i < 10; i++) {
        const box = document.getElementById(`digit-${i}`);
        const freqEl = document.getElementById(`freq-${i}`);
        freqEl.textContent = state.frequencies[i].toFixed(1) + '%';
        box.className = 'digit-box';
        if (i === digit) {
            box.classList.add(isTriple ? 'tripled' : 'active');
        }
    }
}

function checkForTriple(digit, streak) {
    if (streak < 3) return;
    
    state.triplesDetected++;
    document.getElementById('triplesDetected').textContent = state.triplesDetected;
    
    const maxFreq = parseFloat(document.getElementById('maxFreq').value) || 16;
    const freq = state.frequencies[digit];
    
    if (freq >= maxFreq) {
        state.triplesSkipped++;
        document.getElementById('triplesSkipped').textContent = state.triplesSkipped;
        log(`‚ö†Ô∏è Triple D${digit} skipped (freq ${freq.toFixed(1)}% ‚â• ${maxFreq}%)`, 'alert');
        return;
    }
    
    // === OBSERVATION PHASE: Wait for 1 loss first ===
    if (state.observationPhase) {
        // Mark this triple for observation
        state.observedTriple = { digit, freq, streak };
        log(`üëÅÔ∏è OBSERVING: Triple D${digit} (${freq.toFixed(1)}%) - waiting to see result...`, 'info');
        document.getElementById('signalBox').className = 'signal-box waiting';
        document.getElementById('signalBox').textContent = `üëÅÔ∏è OBSERVING D${digit}... (need 1 loss first)`;
        return;
    }
    
    // === TRADING PHASE: After we saw the loss ===
    const maxTradesAfterLoss = 6;
    if (state.tradesAfterLoss >= maxTradesAfterLoss) {
        log(`üèÅ Already made ${maxTradesAfterLoss} trades. Stopping.`, 'info');
        stopBot();
        return;
    }
    
    log(`üéØ TRIPLE D${digit} (${freq.toFixed(1)}%) ‚Üí TRADE #${state.tradesAfterLoss + 1}/6`, 'trade');
    document.getElementById('signalBox').className = 'signal-box trading';
    document.getElementById('signalBox').textContent = `üéØ TRADE #${state.tradesAfterLoss + 1}/6: DIFFERS D${digit}`;
    
    placeTrade(digit, freq);
}

function placeTrade(digit, freq) {
    const stake = parseFloat(document.getElementById('stake').value) || 1;
    state.pendingTrade = { digit, freq, stake, time: new Date().toISOString() };
    
    state.ws.send(JSON.stringify({
        buy: 1,
        price: stake,
        parameters: {
            amount: stake,
            basis: 'stake',
            contract_type: 'DIGITDIFF',
            currency: 'USD',
            duration: 1,
            duration_unit: 't',
            symbol: document.getElementById('symbol').value,
            barrier: digit.toString()
        }
    }));
}

function handleBuyResponse(data) {
    if (data.error) {
        log(`‚ùå Error: ${data.error.message}`, 'loss');
        state.pendingTrade = null;
        document.getElementById('signalBox').className = 'signal-box waiting';
        document.getElementById('signalBox').textContent = '‚è≥ WAITING FOR TRIPLE';
        return;
    }
    if (data.buy) {
        state.pendingContracts.set(data.buy.contract_id, state.pendingTrade);
        log(`üì§ Trade placed: Contract ${data.buy.contract_id}`, 'info');
    }
}

function handleContractUpdate(contract) {
    const info = state.pendingContracts.get(contract.contract_id);
    if (!info) return;
    if (contract.status !== 'won' && contract.status !== 'lost') return;
    
    state.pendingContracts.delete(contract.contract_id);
    state.pendingTrade = null;
    
    const won = contract.status === 'won';
    const profit = parseFloat(contract.profit) || (won ? info.stake * 0.0965 : -info.stake);
    
    state.totalTrades++;
    state.tradesAfterLoss++;
    state.pnl += profit;
    
    if (won) {
        state.wins++;
        state.winStreak++;
        state.bestStreak = Math.max(state.bestStreak, state.winStreak);
        log(`‚úÖ WIN! D${info.digit} didn't repeat ‚Üí +$${profit.toFixed(2)} [Trade ${state.tradesAfterLoss}/6]`, 'win');
    } else {
        state.losses++;
        state.winStreak = 0;
        log(`‚ùå LOSS! D${info.digit} became quad ‚Üí -$${Math.abs(profit).toFixed(2)} [Trade ${state.tradesAfterLoss}/6]`, 'loss');
        
        if (document.getElementById('stopOnLoss').checked) {
            stopBot();
            log('üõë Stopped on loss (conservative mode)', 'alert');
            return;
        }
    }
    
    // Check if we've completed 6 trades
    if (state.tradesAfterLoss >= 6) {
        log(`üèÅ Completed 6 trades! Session finished.`, 'win');
        log(`üìä Final: ${state.wins}W/${state.losses}L | P/L: $${state.pnl.toFixed(2)}`, 'info');
        stopBot();
        return;
    }
    
    updateStats();
    updatePhaseDisplay();
    addTradeEntry(info.digit, info.freq, won, profit);
    
    document.getElementById('signalBox').className = 'signal-box waiting';
    document.getElementById('signalBox').textContent = `‚è≥ WAITING FOR TRIPLE [${state.tradesAfterLoss}/6 trades done]`;
}

function checkLimits() {
    const winTarget = parseInt(document.getElementById('winTarget').value) || 0;
    const maxTrades = parseInt(document.getElementById('maxTrades').value) || 0;
    
    if (winTarget > 0 && state.wins >= winTarget) {
        stopBot();
        log(`üéØ Win target ${winTarget} reached!`, 'win');
    }
    if (maxTrades > 0 && state.totalTrades >= maxTrades) {
        stopBot();
        log(`üéØ Max trades ${maxTrades} reached!`, 'info');
    }
}

function updateStats() {
    document.getElementById('totalTrades').textContent = state.totalTrades;
    document.getElementById('wins').textContent = state.wins;
    document.getElementById('winRate').textContent = state.totalTrades > 0 ? (state.wins / state.totalTrades * 100).toFixed(1) + '%' : '0%';
    document.getElementById('pnl').textContent = '$' + state.pnl.toFixed(2);
    document.getElementById('pnl').className = 'stat-val ' + (state.pnl >= 0 ? 'green' : 'red');
    document.getElementById('winStreak').textContent = state.winStreak;
    document.getElementById('tradeCount').textContent = state.totalTrades;
}

function addTradeEntry(digit, freq, won, profit) {
    const el = document.getElementById('tradeLog');
    if (state.totalTrades === 1) el.innerHTML = '';
    
    const entry = document.createElement('div');
    entry.className = `trade-entry ${won ? 'win' : 'loss'}`;
    entry.innerHTML = `
        <span>D${digit} (${freq.toFixed(1)}%) - ${won ? 'WIN ‚úÖ' : 'LOSS ‚ùå'}</span>
        <span style="color:${won ? 'var(--green)' : 'var(--red)'}">${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}</span>
    `;
    el.insertBefore(entry, el.firstChild);
    
    state.tradeLog.push({
        time: new Date().toISOString(),
        digit, freq: freq.toFixed(1),
        result: won ? 'WIN' : 'LOSS',
        profit: profit.toFixed(2)
    });
}

function startBot() {
    if (!state.connected) return log('Please connect first!', 'alert');
    
    const ticksNeeded = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    if (state.ticks.length < ticksNeeded) {
        return log(`Need ${ticksNeeded} ticks (have ${state.ticks.length}). Wait...`, 'alert');
    }
    
    state.isTrading = true;
    state.totalTrades = 0; state.wins = 0; state.losses = 0;
    state.pnl = 0; state.winStreak = 0;
    state.triplesDetected = 0; state.triplesSkipped = 0;
    state.tradeLog = [];
    
    // Reset observation phase
    state.observationPhase = true;
    state.observedTriple = null;
    state.tradesAfterLoss = 0;
    
    document.getElementById('tradeLog').innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">Phase 1: Observing for loss...</div>';
    document.getElementById('startBtn').disabled = true;
    document.getElementById('signalBox').className = 'signal-box waiting';
    document.getElementById('signalBox').textContent = 'üëÅÔ∏è PHASE 1: Waiting to observe a QUAD (loss)';
    
    updateStats();
    updatePhaseDisplay();
    log('‚ñ∂Ô∏è Bot started! PHASE 1: Observing triples, waiting for a quad...', 'trade');
}

function updatePhaseDisplay() {
    const phaseEl = document.getElementById('phaseDisplay');
    if (phaseEl) {
        if (state.observationPhase) {
            phaseEl.innerHTML = `<span style="color:var(--yellow)">üëÅÔ∏è PHASE 1: OBSERVING</span> - Waiting to see a quad (loss)`;
        } else {
            phaseEl.innerHTML = `<span style="color:var(--green)">üéØ PHASE 2: TRADING</span> - ${state.tradesAfterLoss}/6 trades completed`;
        }
    }
}

function stopBot() {
    state.isTrading = false;
    state.pendingTrade = null;
    state.observationPhase = true;
    state.observedTriple = null;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('signalBox').className = 'signal-box waiting';
    document.getElementById('signalBox').textContent = '‚èπ BOT STOPPED';
    document.getElementById('phaseDisplay').innerHTML = '<span style="color:var(--muted)">Bot stopped - Start to begin new session</span>';
    log('‚èπ Bot stopped', 'info');
}

function exportTrades() {
    if (!state.tradeLog.length) return log('No trades to export', 'alert');
    const csv = ['time,digit,freq,result,profit', ...state.tradeLog.map(t => `${t.time},${t.digit},${t.freq},${t.result},${t.profit}`)].join('\n');
    download(csv, `triple_bounce_trades_${Date.now()}.csv`, 'text/csv');
    log('üì• Trades exported', 'info');
}

function exportActivity() {
    if (!state.activityLog.length) return log('No activity to export', 'alert');
    const txt = state.activityLog.map(a => `[${a.time}] ${a.message}`).join('\n');
    download(txt, `triple_bounce_activity_${Date.now()}.txt`, 'text/plain');
    log('üì• Activity exported', 'info');
}

function download(content, filename, type) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], { type }));
    a.download = filename;
    a.click();
}
</script>
</body>
</html>
