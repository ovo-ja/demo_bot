<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cold Digit Tracker - DIFFERS Bot</title>
    <style>
        :root{--bg:#0a0e17;--card:#1a2235;--border:#2a3549;--text:#f1f5f9;--muted:#64748b;--green:#10b981;--red:#ef4444;--cyan:#06b6d4;--yellow:#f59e0b;--purple:#a855f7;--orange:#f97316;--blue:#3b82f6}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);padding:10px;font-size:13px}
        .container{max-width:1400px;margin:0 auto}
        .header{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:2px solid var(--cyan);margin-bottom:10px}
        .header h1{font-size:18px;color:var(--cyan)}
        .status{display:flex;align-items:center;gap:8px}
        .dot{width:12px;height:12px;border-radius:50%;background:var(--muted)}
        .dot.on{background:var(--green);box-shadow:0 0 10px var(--green)}
        .balance{font-family:monospace;font-size:16px;color:var(--green)}
        .time{font-size:11px;color:var(--muted)}
        
        .grid{display:grid;grid-template-columns:280px 1fr 280px;gap:10px}
        @media(max-width:1200px){.grid{grid-template-columns:1fr}}
        
        .card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px}
        .card h3{font-size:10px;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
        .card.highlight{border:2px solid var(--cyan);background:rgba(6,182,212,0.05)}
        .card.warning{border:2px solid var(--yellow);background:rgba(245,158,11,0.1)}
        
        label{display:block;font-size:10px;color:var(--muted);margin-bottom:2px}
        input,select{width:100%;padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:12px;margin-bottom:6px}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
        
        button{padding:8px 12px;border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:11px;text-transform:uppercase;transition:all 0.2s}
        .btn-blue{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;width:100%}
        .btn-cyan{background:var(--cyan);color:black}
        .btn-green{background:var(--green);color:white}
        .btn-red{background:var(--red);color:white}
        .btn-orange{background:var(--orange);color:white}
        .rapid-opt{flex:1;padding:8px;background:var(--bg);border:2px solid var(--border);color:var(--text);font-size:14px}
        .rapid-opt:hover{border-color:var(--orange)}
        .rapid-opt.active{border-color:var(--orange);background:rgba(249,115,22,0.2);color:var(--orange)}
        
        /* Digit Display */
        .digit-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin:10px 0}
        .digit-box{background:var(--bg);border:2px solid var(--border);border-radius:8px;padding:10px 6px;text-align:center;cursor:pointer;transition:all 0.2s;position:relative}
        .digit-box:hover{border-color:var(--cyan)}
        .digit-box.selected{border-color:var(--orange)!important;background:rgba(249,115,22,0.25)!important;box-shadow:0 0 15px rgba(249,115,22,0.4)}
        .digit-box.valid{border-color:var(--green);background:rgba(16,185,129,0.1)}
        .digit-box.valid::after{content:"‚úì";position:absolute;top:2px;right:4px;font-size:10px;color:var(--green)}
        .digit-box.coldest{border-color:var(--cyan)!important;background:rgba(6,182,212,0.25)!important;box-shadow:0 0 20px rgba(6,182,212,0.5);animation:glow 1.5s ease-in-out infinite}
        .digit-box.coldest::before{content:"‚ùÑÔ∏è";position:absolute;top:2px;left:4px;font-size:10px}
        .digit-box.just-occurred{border-color:var(--yellow)!important;background:rgba(245,158,11,0.4)!important;box-shadow:0 0 30px rgba(245,158,11,0.8),0 0 60px rgba(245,158,11,0.4);transform:scale(1.08);animation:flash-digit 0.5s ease-out}
        .digit-box.just-occurred .digit-num{color:var(--yellow);text-shadow:0 0 10px var(--yellow)}
        .digit-box.doubled{border-color:var(--red)!important;background:rgba(239,68,68,0.4)!important;box-shadow:0 0 30px rgba(239,68,68,0.8),0 0 60px rgba(239,68,68,0.4);transform:scale(1.1);animation:pulse-double 0.5s ease-in-out infinite}
        .digit-box.doubled .digit-num{color:var(--red);text-shadow:0 0 15px var(--red)}
        .digit-box.doubled .digit-status{color:var(--red)!important;font-weight:700;font-size:9px}
        .digit-box.tripled{border-color:#a855f7!important;background:rgba(168,85,247,0.5)!important;box-shadow:0 0 40px rgba(168,85,247,0.9),0 0 80px rgba(168,85,247,0.5);transform:scale(1.15);animation:pulse-triple 0.3s ease-in-out infinite}
        .digit-box.tripled .digit-num{color:#a855f7;text-shadow:0 0 20px #a855f7}
        .digit-box.tripled .digit-status{color:#a855f7!important;font-weight:700;font-size:9px}
        @keyframes pulse-triple{0%,100%{transform:scale(1.15);box-shadow:0 0 40px rgba(168,85,247,0.9)}50%{transform:scale(1.2);box-shadow:0 0 70px rgba(168,85,247,1)}}
        @keyframes pulse-double{0%,100%{transform:scale(1.1);box-shadow:0 0 30px rgba(239,68,68,0.8)}50%{transform:scale(1.15);box-shadow:0 0 50px rgba(239,68,68,1)}}
        @keyframes flash-digit{0%{transform:scale(1.15);box-shadow:0 0 50px rgba(245,158,11,1)}100%{transform:scale(1.08);box-shadow:0 0 30px rgba(245,158,11,0.8)}}
        @keyframes glow{0%,100%{box-shadow:0 0 15px rgba(6,182,212,0.4)}50%{box-shadow:0 0 25px rgba(6,182,212,0.7)}}
        .digit-num{font-size:24px;font-weight:700;transition:all 0.2s}
        .digit-pct{font-size:14px;color:var(--muted);margin-top:4px;font-weight:600}
        .digit-pct.cold{color:var(--green);font-weight:700}
        .digit-pct.coldest{color:var(--cyan);font-weight:700;font-size:15px}
        .digit-status{font-size:8px;color:var(--green);margin-top:2px;min-height:12px}
        .digit-status.coldest{color:var(--cyan);font-weight:700}
        
        /* Mode Toggle */
        .mode-toggle{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin:10px 0}
        .mode-btn{padding:12px;background:var(--bg);border:2px solid var(--border);border-radius:6px;font-weight:700;cursor:pointer;text-align:center}
        .mode-btn.active{border-color:var(--cyan);background:rgba(6,182,212,0.2);color:var(--cyan)}
        
        /* Auto Mode Display */
        .auto-status{background:var(--bg);border-radius:8px;padding:15px;text-align:center;margin:10px 0}
        .auto-status.watching{border:2px solid var(--yellow);background:rgba(245,158,11,0.1)}
        .auto-status.ready{border:2px solid var(--green);background:rgba(16,185,129,0.1)}
        .auto-status.no-target{border:2px solid var(--red);background:rgba(239,68,68,0.1)}
        .auto-icon{font-size:32px;margin-bottom:5px}
        .auto-text{font-size:14px;font-weight:600}
        .auto-sub{font-size:11px;color:var(--muted);margin-top:4px}
        
        /* Manual Controls */
        .manual-controls{background:var(--bg);border-radius:8px;padding:12px;margin:10px 0}
        .trade-presets{display:flex;gap:4px;margin:8px 0}
        .preset-btn{flex:1;padding:8px;background:var(--card);border:2px solid var(--border);border-radius:4px;font-weight:700;cursor:pointer;text-align:center;font-size:12px}
        .preset-btn:hover{border-color:var(--orange)}
        .preset-btn.active{border-color:var(--orange);background:rgba(249,115,22,0.2);color:var(--orange)}
        
        .trade-buttons{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
        .single-btn{padding:15px;font-size:14px;background:linear-gradient(135deg,var(--cyan),var(--blue));color:white;border:none;border-radius:8px;cursor:pointer}
        .rapid-btn{padding:15px;font-size:14px;background:linear-gradient(135deg,var(--orange),#ea580c);color:white;border:none;border-radius:8px;cursor:pointer}
        .single-btn:hover,.rapid-btn:hover{transform:scale(1.02);box-shadow:0 0 15px rgba(6,182,212,0.4)}
        
        /* Stats */
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:10px 0}
        .stat{background:var(--bg);padding:8px;border-radius:6px;text-align:center}
        .stat-val{font-size:16px;font-weight:700;font-family:monospace}
        .stat-val.pos{color:var(--green)}
        .stat-val.neg{color:var(--red)}
        .stat-label{font-size:8px;color:var(--muted);text-transform:uppercase}
        
        /* Log */
        .log{background:var(--bg);border-radius:4px;padding:6px;max-height:150px;overflow-y:auto;font-family:monospace;font-size:9px}
        .log div{padding:2px 0;border-bottom:1px solid var(--border)}
        .log .win{color:var(--green)}
        .log .loss{color:var(--red)}
        .log .info{color:var(--cyan)}
        .log .alert{color:var(--yellow)}
        .log .trade{color:var(--orange);font-weight:bold}
        
        /* Trades */
        .trades{max-height:200px;overflow-y:auto}
        .trade-row{display:flex;justify-content:space-between;padding:4px 6px;background:var(--bg);margin-bottom:2px;border-radius:4px;font-size:10px;border-left:3px solid var(--border)}
        .trade-row.win{border-left-color:var(--green)}
        .trade-row.loss{border-left-color:var(--red)}
        
        /* Ticker */
        .ticker{display:flex;flex-wrap:wrap;gap:3px;margin-top:8px;min-height:20px}
        .tick{width:18px;height:18px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700}
        .tick.win{background:var(--green);color:white}
        .tick.loss{background:var(--red);color:white}
        .tick.pending{background:var(--yellow);color:black}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéØ Cold Digit Tracker</h1>
        <div class="status">
            <span class="time" id="torontoTime">--:--:-- EST</span>
            <span class="balance" id="balance">$0.00</span>
            <div class="dot" id="dot"></div>
            <span id="status">Offline</span>
        </div>
    </div>
    
    <div class="grid">
        <!-- LEFT: Connection & Settings -->
        <div>
            <div class="card">
                <h3>üîå Connection</h3>
                <label>API Token</label>
                <input type="password" id="token">
                <button class="btn-blue" id="connectBtn" onclick="connect()">Connect</button>
            </div>
            
            <div class="card">
                <h3>üìä Select Pair</h3>
                <label>Symbol</label>
                <select id="symbol" onchange="changePair()">
                    <optgroup label="Volatility (1-second)">
                        <option value="1HZ10V">Volatility 10 (1s)</option>
                        <option value="1HZ25V">Volatility 25 (1s)</option>
                        <option value="1HZ50V">Volatility 50 (1s)</option>
                        <option value="1HZ75V">Volatility 75 (1s)</option>
                        <option value="1HZ100V" selected>Volatility 100 (1s)</option>
                    </optgroup>
                    <optgroup label="Volatility (Standard)">
                        <option value="R_10">Volatility 10</option>
                        <option value="R_25">Volatility 25</option>
                        <option value="R_50">Volatility 50</option>
                        <option value="R_75">Volatility 75</option>
                        <option value="R_100">Volatility 100</option>
                    </optgroup>
                    <optgroup label="Jump Indices">
                        <option value="JD10">Jump 10</option>
                        <option value="JD25">Jump 25</option>
                        <option value="JD50">Jump 50</option>
                        <option value="JD75">Jump 75</option>
                        <option value="JD100">Jump 100</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="card">
                <h3>‚öôÔ∏è Trade Settings</h3>
                <div class="row">
                    <div>
                        <label>Stake ($)</label>
                        <input type="number" id="stake" value="10" min="1">
                    </div>
                    <div>
                        <label>Ticks</label>
                        <select id="ticks">
                            <option value="1" selected>1 tick</option>
                            <option value="2">2 ticks</option>
                            <option value="3">3 ticks</option>
                            <option value="5">5 ticks</option>
                        </select>
                    </div>
                </div>
                <label>Valid Threshold (under %)</label>
                <input type="number" id="threshold" value="7" min="1" max="10">
                <label>Ticks to Analyze</label>
                <input type="number" id="ticksToAnalyze" value="100" min="30" max="500">
                
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
                    <label>üéØ Auto Trade Strategies (select multiple)</label>
                    
                    <div class="strat-row" style="display:flex;align-items:center;gap:6px;margin:6px 0;padding:6px;background:var(--bg);border-radius:4px">
                        <input type="checkbox" id="stratCold" style="width:auto;margin:0">
                        <span style="flex:1">‚ùÑÔ∏è Cold Only</span>
                        <span style="font-size:9px;color:var(--muted)">‚â§</span>
                        <input type="number" id="coldThreshold" value="5.5" min="1" max="15" step="0.1" style="width:50px;padding:2px 4px;margin:0">
                        <span style="font-size:9px;color:var(--muted)">%</span>
                    </div>
                    
                    <div class="strat-row" style="display:flex;align-items:center;gap:6px;margin:6px 0;padding:6px;background:var(--bg);border-radius:4px">
                        <input type="checkbox" id="stratDouble" style="width:auto;margin:0" onchange="toggleDoubleOptions()">
                        <span style="flex:1">üî• Double Only</span>
                        <span style="font-size:9px;color:var(--muted)">any repeat</span>
                    </div>
                    
                    <div class="strat-row" style="display:flex;align-items:center;gap:6px;margin:6px 0;padding:6px;background:var(--bg);border-radius:4px">
                        <input type="checkbox" id="stratDoubleCold" style="width:auto;margin:0">
                        <span style="flex:1">üî•‚ùÑÔ∏è Double + Cold</span>
                        <span style="font-size:9px;color:var(--muted)">‚â§</span>
                        <input type="number" id="doubleColdThreshold" value="7" min="1" max="15" step="0.1" style="width:50px;padding:2px 4px;margin:0">
                        <span style="font-size:9px;color:var(--muted)">%</span>
                    </div>
                    
                    <div class="strat-row" style="display:flex;align-items:center;gap:6px;margin:6px 0;padding:6px;background:var(--bg);border-radius:4px">
                        <input type="checkbox" id="stratTripleCold" style="width:auto;margin:0">
                        <span style="flex:1">üî•üî•üî•‚ùÑÔ∏è Triple + Cold</span>
                        <span style="font-size:9px;color:var(--muted)">‚â§</span>
                        <input type="number" id="tripleColdThreshold" value="9" min="1" max="15" step="0.1" style="width:50px;padding:2px 4px;margin:0">
                        <span style="font-size:9px;color:var(--muted)">%</span>
                    </div>
                    
                    <div id="doubleOptionsSection" style="margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:4px;display:none">
                        <label style="font-size:10px">üî• Double Options</label>
                        <div style="display:flex;gap:4px;margin-top:4px">
                            <button type="button" class="rapid-opt active" onclick="setDoubleRapid(1)">1x</button>
                            <button type="button" class="rapid-opt" onclick="setDoubleRapid(2)">2x</button>
                            <button type="button" class="rapid-opt" onclick="setDoubleRapid(3)">3x</button>
                        </div>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;margin-top:6px;font-size:10px">
                            <input type="checkbox" id="enableTripleRecovery" checked style="width:auto;margin:0">
                            <span>üî•üî•üî• Triple Recovery (rapid 2 if triple)</span>
                        </label>
                    </div>
                    
                    <div id="strategyStatus" style="font-size:9px;color:var(--muted);margin-top:6px;padding:4px;background:var(--bg);border-radius:4px;text-align:center">
                        Select at least one strategy
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìà Session Stats</h3>
                <div class="stats-grid" style="grid-template-columns:1fr 1fr">
                    <div class="stat"><div class="stat-val" id="totalTrades">0</div><div class="stat-label">Trades</div></div>
                    <div class="stat"><div class="stat-val" id="totalWins">0</div><div class="stat-label">Wins</div></div>
                    <div class="stat"><div class="stat-val" id="winRate">0%</div><div class="stat-label">Win Rate</div></div>
                    <div class="stat"><div class="stat-val pos" id="totalPL">$0</div><div class="stat-label">P/L</div></div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìã Activity Log</h3>
                <div class="log" id="log"></div>
            </div>
        </div>
        
        <!-- MIDDLE: Main Display -->
        <div>
            <!-- Digit Frequency Grid -->
            <div class="card highlight">
                <h3>üî¢ Digit Frequency <span id="tickCount" style="float:right;color:var(--cyan)">0 ticks</span></h3>
                <div style="display:flex;justify-content:center;align-items:center;gap:15px;margin-bottom:8px;padding:10px;background:var(--bg);border-radius:8px;flex-wrap:wrap">
                    <div style="text-align:center">
                        <span style="font-size:9px;color:var(--muted)">BALANCE</span>
                        <div id="balanceDisplay" style="font-size:18px;font-weight:700;color:var(--green);font-family:monospace">$0.00</div>
                    </div>
                    <div style="text-align:center">
                        <span style="font-size:9px;color:var(--muted)">STREAK</span>
                        <div id="streakDisplay" style="font-size:18px;font-weight:700;color:var(--green);font-family:monospace">0 üî•</div>
                    </div>
                    <div style="text-align:center">
                        <span style="font-size:9px;color:var(--muted)">BEST</span>
                        <div id="bestStreakDisplay" style="font-size:18px;font-weight:700;color:var(--cyan);font-family:monospace">0</div>
                    </div>
                    <div style="text-align:center">
                        <span style="font-size:9px;color:var(--muted)">PRICE</span>
                        <div id="priceDisplay" style="font-size:16px;font-weight:600;color:var(--text);font-family:monospace">-.-----</div>
                    </div>
                    <div style="text-align:center">
                        <span style="font-size:9px;color:var(--muted)">LAST DIGIT</span>
                        <div id="lastDigitDisplay" style="font-size:48px;font-weight:700;color:var(--yellow);text-shadow:0 0 20px var(--yellow);line-height:1">-</div>
                    </div>
                </div>
                <div class="digit-grid" id="digitGrid"></div>
                <div style="font-size:9px;color:var(--muted);margin-top:4px">
                    üü° Yellow = Just occurred | üî¥ Red = DOUBLED | üü£ Purple = TRIPLED | üü¢ Green = Valid (<span id="thresholdDisplay">7</span>%) | ‚ùÑÔ∏è Cyan = Coldest
                </div>
            </div>
            
            <!-- Mode Toggle -->
            <div class="card">
                <h3>üéÆ Trading Mode</h3>
                <div class="mode-toggle">
                    <div class="mode-btn active" id="modeAuto" onclick="setMode('auto')">ü§ñ Auto Mode<br><span style="font-size:9px;font-weight:normal">Cold digit trigger</span></div>
                    <div class="mode-btn" id="modeManual" onclick="setMode('manual')">üñêÔ∏è Manual Mode<br><span style="font-size:9px;font-weight:normal">Full control</span></div>
                </div>
            </div>
            
            <!-- Auto Mode Status -->
            <div id="autoSection">
                <div class="auto-status" id="autoStatus">
                    <div class="auto-icon">‚è≥</div>
                    <div class="auto-text">Collecting ticks...</div>
                    <div class="auto-sub">Need 100 ticks to start scanning</div>
                </div>
                <button class="btn-green" id="startAutoBtn" onclick="startAuto()" style="width:100%;padding:12px;display:none">‚ñ∂Ô∏è START AUTO MODE</button>
                <button class="btn-red" id="stopAutoBtn" onclick="stopAuto()" style="width:100%;padding:12px;display:none;margin-top:6px">‚èπÔ∏è STOP AUTO MODE</button>
            </div>
            
            <!-- Manual Mode Controls -->
            <div id="manualSection" style="display:none">
                <div class="manual-controls">
                    <div style="text-align:center;margin-bottom:8px">
                        <span style="font-size:12px;color:var(--muted)">Selected Digit:</span>
                        <span style="font-size:24px;font-weight:700;color:var(--orange);margin-left:8px" id="selectedDigitDisplay">-</span>
                    </div>
                    
                    <label>Rapid Fire Trades</label>
                    <div class="trade-presets">
                        <div class="preset-btn" onclick="setRapidCount(1)">1</div>
                        <div class="preset-btn" onclick="setRapidCount(3)">3</div>
                        <div class="preset-btn active" onclick="setRapidCount(5)">5</div>
                        <div class="preset-btn" onclick="setRapidCount(10)">10</div>
                    </div>
                    <input type="number" id="rapidCount" value="5" min="1" max="20" style="text-align:center">
                    
                    <div class="trade-buttons">
                        <button class="single-btn" id="singleBtn" onclick="placeSingleTrade()">
                            üéØ SINGLE TRADE<br><span style="font-size:10px;font-weight:normal">(1 trade)</span>
                        </button>
                        <button class="rapid-btn" id="rapidBtn" onclick="placeRapidFire()">
                            üî• RAPID FIRE<br><span style="font-size:10px;font-weight:normal" id="rapidLabel">(5 trades)</span>
                        </button>
                    </div>
                </div>
                
                <!-- Rapid Fire Results -->
                <div class="stats-grid" id="rapidStats" style="display:none">
                    <div class="stat"><div class="stat-val" id="rapidTrades">0</div><div class="stat-label">Trades</div></div>
                    <div class="stat"><div class="stat-val pos" id="rapidWins">0</div><div class="stat-label">Wins</div></div>
                    <div class="stat"><div class="stat-val neg" id="rapidLosses">0</div><div class="stat-label">Losses</div></div>
                    <div class="stat"><div class="stat-val" id="rapidPL">$0</div><div class="stat-label">P/L</div></div>
                </div>
                <div class="ticker" id="ticker"></div>
            </div>
        </div>
        
        <!-- RIGHT: History -->
        <div>
            <div class="card">
                <h3>üìú Trade History</h3>
                <div class="trades" id="trades">
                    <div style="text-align:center;color:var(--muted);padding:15px">No trades yet</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üéØ Auto Triggers</h3>
                <div class="trades" id="triggers">
                    <div style="text-align:center;color:var(--muted);padding:15px">No auto triggers yet</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üì• Export</h3>
                <button class="btn-blue" onclick="exportCSV()" style="margin-bottom:6px">Export CSV</button>
                <button class="btn-blue" onclick="resetStats()">Reset Stats</button>
            </div>
        </div>
    </div>
</div>

<script>
// =============================================
// STATE
// =============================================
const state = {
    ws: null,
    connected: false,
    ticks: [],
    trades: [],
    triggers: [],
    pendingContracts: new Map(),
    pipSize: 2,
    
    // Mode
    mode: 'auto',
    autoRunning: false,
    
    // Selection
    selectedDigit: null,
    validTargets: [],
    
    // Auto mode
    currentTarget: null,
    waitingForDigit: false,
    tradePending: false,  // Prevents multiple trades while one is processing
    
    // Double detection
    lastPriceDigit: null,     // Previous tick's digit
    doubleDetected: false,    // True when same digit appears twice
    doubleDigit: null,        // Which digit just doubled
    doubleRapidCount: 1,      // How many trades to place on double (1, 2, or 3)
    
    // Triple recovery
    consecutiveCount: 1,      // How many times current digit appeared in a row
    lastTradedDigit: null,    // Which digit we just traded on (for triple detection)
    waitingForTriple: false,  // Are we watching for triple after a double trade?
    
    // Rapid fire
    rapidCount: 5,
    rapidInProgress: false,
    rapidResults: [],
    rapidTradesPlaced: 0,
    rapidWins: 0,
    rapidLosses: 0,
    rapidPL: 0,
    
    // Streak tracking
    currentStreak: 0,
    bestStreak: 0,
    
    // Stats
    totalStats: { trades: 0, wins: 0, pl: 0 }
};

// =============================================
// TORONTO TIME
// =============================================
function updateTorontoTime() {
    const now = new Date();
    const toronto = now.toLocaleString('en-US', { 
        timeZone: 'America/Toronto',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
    });
    document.getElementById('torontoTime').textContent = toronto + ' EST';
}
setInterval(updateTorontoTime, 1000);
updateTorontoTime();

// =============================================
// HELPERS
// =============================================
function extractDigit(quote, pipSize) {
    const multiplier = Math.pow(10, pipSize);
    return Math.round(quote * multiplier) % 10;
}

function log(msg, type = '') {
    const el = document.getElementById('log');
    const time = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Toronto' });
    el.innerHTML = `<div class="${type}">[${time}] ${msg}</div>` + el.innerHTML;
    if (el.children.length > 100) el.removeChild(el.lastChild);
}

function getTimestamp() {
    return new Date().toLocaleString('en-US', { timeZone: 'America/Toronto' });
}

// =============================================
// INIT
// =============================================
window.onload = () => {
    const grid = document.getElementById('digitGrid');
    for (let i = 0; i < 10; i++) {
        const box = document.createElement('div');
        box.className = 'digit-box';
        box.id = `digit-${i}`;
        box.innerHTML = `
            <div class="digit-num">${i}</div>
            <div class="digit-pct" id="pct-${i}">--%</div>
            <div class="digit-status" id="status-${i}"></div>
        `;
        box.onclick = () => selectDigit(i);
        grid.appendChild(box);
    }
    
    try {
        const saved = JSON.parse(localStorage.getItem('coldDigitBot') || '{}');
        if (saved.token) document.getElementById('token').value = saved.token;
        if (saved.totalStats) state.totalStats = saved.totalStats;
        if (saved.currentStreak !== undefined) state.currentStreak = saved.currentStreak;
        if (saved.bestStreak !== undefined) state.bestStreak = saved.bestStreak;
        updateTotalStats();
        updateStreakDisplay();
    } catch(e) {}
    
    document.getElementById('rapidCount').addEventListener('input', (e) => {
        state.rapidCount = parseInt(e.target.value) || 5;
        updateRapidLabel();
    });
    
    document.getElementById('threshold').addEventListener('input', () => {
        document.getElementById('thresholdDisplay').textContent = document.getElementById('threshold').value;
        analyzeDigits();
    });
    
    document.getElementById('ticksToAnalyze').addEventListener('input', () => {
        analyzeDigits();
    });
    
    log('Cold Digit Tracker ready!', 'info');
};

function saveSettings() {
    localStorage.setItem('coldDigitBot', JSON.stringify({
        token: document.getElementById('token').value,
        totalStats: state.totalStats,
        currentStreak: state.currentStreak,
        bestStreak: state.bestStreak
    }));
}

// =============================================
// CONNECTION
// =============================================
function connect() {
    const token = document.getElementById('token').value.trim();
    if (!token) return log('Enter API token!', 'loss');
    
    saveSettings();
    log('Connecting...', 'info');
    
    state.ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
    state.ws.onopen = () => state.ws.send(JSON.stringify({ authorize: token }));
    state.ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
    state.ws.onerror = () => log('Connection error!', 'loss');
    state.ws.onclose = () => {
        state.connected = false;
        document.getElementById('dot').classList.remove('on');
        document.getElementById('status').textContent = 'Offline';
    };
}

function handleMessage(data) {
    if (data.error) {
        log(`Error: ${data.error.message}`, 'loss');
        return;
    }
    
    if (data.authorize) {
        state.connected = true;
        document.getElementById('dot').classList.add('on');
        document.getElementById('status').textContent = 'Online';
        document.getElementById('balance').textContent = `$${data.authorize.balance.toFixed(2)}`;
        document.getElementById('balanceDisplay').textContent = `$${data.authorize.balance.toFixed(2)}`;
        document.getElementById('connectBtn').style.display = 'none';
        log(`Connected: ${data.authorize.loginid}`, 'info');
        
        subscribeToPair();
        state.ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
    }
    
    if (data.tick) handleTick(data.tick);
    
    if (data.proposal) {
        state.ws.send(JSON.stringify({ buy: data.proposal.id, price: data.proposal.ask_price }));
    }
    
    if (data.buy) {
        const digit = state.mode === 'auto' ? state.currentTarget : state.selectedDigit;
        state.pendingContracts.set(data.buy.contract_id, {
            digit: digit,
            stake: parseFloat(document.getElementById('stake').value),
            isRapid: state.rapidInProgress
        });
        state.ws.send(JSON.stringify({ 
            proposal_open_contract: 1, 
            contract_id: data.buy.contract_id, 
            subscribe: 1 
        }));
        
        if (state.rapidInProgress) {
            state.rapidTradesPlaced++;
            state.rapidResults.push('pending');
            updateRapidDisplay();
        }
    }
    
    if (data.proposal_open_contract && data.proposal_open_contract.is_sold) {
        handleResult(data.proposal_open_contract);
    }
    
    if (data.balance) {
        document.getElementById('balance').textContent = `$${data.balance.balance.toFixed(2)}`;
        document.getElementById('balanceDisplay').textContent = `$${data.balance.balance.toFixed(2)}`;
    }
}

function subscribeToPair() {
    const symbol = document.getElementById('symbol').value;
    state.ticks = [];
    state.ws.send(JSON.stringify({ forget_all: 'ticks' }));
    state.ws.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
    log(`Subscribed to ${symbol}`, 'info');
}

function changePair() {
    if (state.connected) {
        state.autoRunning = false;
        state.waitingForDigit = false;
        state.currentTarget = null;
        state.lastPriceDigit = null;
        state.doubleDetected = false;
        state.doubleDigit = null;
        state.consecutiveCount = 1;
        state.waitingForTriple = false;
        state.lastTradedDigit = null;
        subscribeToPair();
        updateAutoStatus();
    }
}

// =============================================
// TICK HANDLING
// =============================================
function handleTick(tick) {
    if (tick.pip_size !== undefined) state.pipSize = tick.pip_size;
    
    const digit = extractDigit(tick.quote, state.pipSize);
    state.ticks.push({ digit, time: Date.now() });
    if (state.ticks.length > 1000) state.ticks.shift();
    
    const ticksToAnalyze = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    document.getElementById('tickCount').textContent = `${state.ticks.length}/${ticksToAnalyze} ticks`;
    
    // Update price and digit displays
    document.getElementById('priceDisplay').textContent = tick.quote.toFixed(state.pipSize);
    document.getElementById('lastDigitDisplay').textContent = digit;
    
    // CONSECUTIVE COUNT: Track how many times same digit in a row
    if (state.lastPriceDigit !== null && digit === state.lastPriceDigit) {
        state.consecutiveCount++;
    } else {
        state.consecutiveCount = 1;
        state.waitingForTriple = false; // Reset when different digit appears
    }
    
    const isDouble = (state.consecutiveCount === 2);
    const isTriple = (state.consecutiveCount === 3);
    
    // Clear previous states
    document.querySelectorAll('.digit-box').forEach(box => {
        box.classList.remove('just-occurred', 'doubled', 'tripled');
    });
    
    // Update digit status text
    for (let i = 0; i < 10; i++) {
        const statusEl = document.getElementById(`status-${i}`);
        if (statusEl && (statusEl.textContent === 'üî• DOUBLED!' || statusEl.textContent === 'üî•üî•üî• TRIPLED!')) {
            statusEl.textContent = '';
        }
    }
    
    if (isTriple) {
        // TRIPLE DETECTED! - Calculate cold percentage for logging
        const tripleColdThreshold = parseFloat(document.getElementById('tripleColdThreshold').value) || 9;
        const recent = state.ticks.slice(-ticksToAnalyze);
        let tripleFreq = 0;
        let coldStatus = '';
        
        if (recent.length >= 50) {
            const counts = [0,0,0,0,0,0,0,0,0,0];
            recent.forEach(t => counts[t.digit]++);
            tripleFreq = counts[digit] / recent.length * 100;
            coldStatus = tripleFreq <= tripleColdThreshold ? ` ‚ùÑÔ∏è COLD (‚â§${tripleColdThreshold}%)` : ` (>${tripleColdThreshold}%)`;
        }
        
        state.doubleDetected = false;
        state.doubleDigit = null;
        document.getElementById(`digit-${digit}`).classList.add('tripled');
        document.getElementById(`status-${digit}`).textContent = 'üî•üî•üî• TRIPLED!';
        log(`üî•üî•üî• TRIPLE: Digit ${digit} appeared 3x! Freq: ${tripleFreq.toFixed(1)}%${coldStatus}`, 'alert');
    } else if (isDouble) {
        // DOUBLE DETECTED! - Calculate frequency for logging
        const doubleColdThreshold = parseFloat(document.getElementById('doubleColdThreshold').value) || 7;
        const recent = state.ticks.slice(-ticksToAnalyze);
        let doubleFreq = 0;
        let coldStatus = '';
        
        if (recent.length >= 50) {
            const counts = [0,0,0,0,0,0,0,0,0,0];
            recent.forEach(t => counts[t.digit]++);
            doubleFreq = counts[digit] / recent.length * 100;
            coldStatus = doubleFreq <= doubleColdThreshold ? ` ‚ùÑÔ∏è (‚â§${doubleColdThreshold}%)` : '';
        }
        
        state.doubleDetected = true;
        state.doubleDigit = digit;
        document.getElementById(`digit-${digit}`).classList.add('doubled');
        document.getElementById(`status-${digit}`).textContent = 'üî• DOUBLED!';
        log(`üî• DOUBLE: Digit ${digit} (${doubleFreq.toFixed(1)}%${coldStatus})`, 'alert');
    } else {
        state.doubleDetected = false;
        state.doubleDigit = null;
        document.getElementById(`digit-${digit}`).classList.add('just-occurred');
    }
    
    // Update lastPriceDigit for next comparison
    state.lastPriceDigit = digit;
    
    analyzeDigits();
    
    // Get enabled strategies
    const stratCold = document.getElementById('stratCold')?.checked;
    const stratDouble = document.getElementById('stratDouble')?.checked;
    const stratDoubleCold = document.getElementById('stratDoubleCold')?.checked;
    const stratTripleCold = document.getElementById('stratTripleCold')?.checked;
    const enableTripleRecovery = document.getElementById('enableTripleRecovery')?.checked;
    
    // TRIPLE RECOVERY: Check if we should recover after a triple (only for Double Only strategy)
    if (state.autoRunning && !state.tradePending && isTriple && state.waitingForTriple && enableTripleRecovery && stratDouble) {
        // Triple occurred and we were waiting for it (our double trade just lost)
        state.waitingForTriple = false;
        log(`üí• Triple recovery triggered! Digit ${digit} - Rapid 2 to recover...`, 'trade');
        
        state.triggers.push({
            time: getTimestamp(),
            digit: digit,
            freq: 0,
            reason: 'üî•üî•üî• Triple Recovery'
        });
        updateTriggerHistory();
        
        // Rapid 2 trades for recovery
        state.tradePending = true;
        placeTrade(digit);
        setTimeout(() => {
            placeTrade(digit);
            log(`üî• Recovery trade 2/2 on digit ${digit}`, 'trade');
        }, 300);
        
        setTimeout(() => {
            state.tradePending = false;
            if (state.autoRunning) updateAutoStatus();
        }, 2500);
        
        return; // Don't process normal auto trading
    }
    
    // AUTO TRADING LOGIC - Check all enabled strategies
    if (state.autoRunning && !state.tradePending) {
        // Get individual thresholds
        const coldThreshold = parseFloat(document.getElementById('coldThreshold').value) || 5.5;
        const doubleColdThreshold = parseFloat(document.getElementById('doubleColdThreshold').value) || 7;
        const tripleColdThreshold = parseFloat(document.getElementById('tripleColdThreshold').value) || 9;
        
        const recent = state.ticks.slice(-ticksToAnalyze);
        
        if (recent.length >= ticksToAnalyze) {
            // Calculate frequency of the digit that just occurred
            const counts = [0,0,0,0,0,0,0,0,0,0];
            recent.forEach(t => counts[t.digit]++);
            const digitFreq = counts[digit] / recent.length * 100;
            
            let shouldTrade = false;
            let tradeReason = '';
            let useDoubleRapid = false;
            
            // Check strategies in priority order (each with its own threshold)
            
            // 1. Triple + Cold (most specific)
            if (!shouldTrade && stratTripleCold && isTriple && digitFreq <= tripleColdThreshold) {
                shouldTrade = true;
                tradeReason = `üî•üî•üî•‚ùÑÔ∏è Triple+Cold (${digitFreq.toFixed(1)}% ‚â§ ${tripleColdThreshold}%)`;
            }
            
            // 2. Double + Cold
            if (!shouldTrade && stratDoubleCold && isDouble && digitFreq <= doubleColdThreshold) {
                shouldTrade = true;
                tradeReason = `üî•‚ùÑÔ∏è Double+Cold (${digitFreq.toFixed(1)}% ‚â§ ${doubleColdThreshold}%)`;
            }
            
            // 3. Double Only (any double, ignore frequency)
            if (!shouldTrade && stratDouble && isDouble) {
                shouldTrade = true;
                useDoubleRapid = true;
                tradeReason = `üî• Double (${digitFreq.toFixed(1)}%)`;
                if (state.doubleRapidCount > 1) {
                    tradeReason += ` x${state.doubleRapidCount}`;
                }
            }
            
            // 4. Cold Only
            if (!shouldTrade && stratCold && digitFreq <= coldThreshold) {
                shouldTrade = true;
                tradeReason = `‚ùÑÔ∏è Cold (${digitFreq.toFixed(1)}% ‚â§ ${coldThreshold}%)`;
            }
            
            if (shouldTrade) {
                state.currentTarget = digit;
                triggerAutoTrade(digit, digitFreq, tradeReason, useDoubleRapid);
            }
        }
    }
}

function analyzeDigits() {
    const threshold = parseFloat(document.getElementById('threshold').value) || 7;
    const ticksToAnalyze = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    
    if (state.ticks.length < Math.min(50, ticksToAnalyze)) {
        updateAutoStatus();
        return;
    }
    
    const recent = state.ticks.slice(-ticksToAnalyze);
    const counts = [0,0,0,0,0,0,0,0,0,0];
    recent.forEach(t => counts[t.digit]++);
    
    state.validTargets = [];
    
    // Find coldest digit (lowest frequency)
    let coldestDigit = 0;
    let coldestFreq = 100;
    
    for (let i = 0; i < 10; i++) {
        const freq = counts[i] / recent.length * 100;
        if (freq < coldestFreq) {
            coldestFreq = freq;
            coldestDigit = i;
        }
        if (freq < threshold) {
            state.validTargets.push({ digit: i, freq });
        }
    }
    
    // Update UI for all digits
    for (let i = 0; i < 10; i++) {
        const freq = counts[i] / recent.length * 100;
        const isValid = freq < threshold;
        const isColdest = i === coldestDigit;
        const isSelected = i === state.selectedDigit;
        
        const box = document.getElementById(`digit-${i}`);
        const pctEl = document.getElementById(`pct-${i}`);
        const statusEl = document.getElementById(`status-${i}`);
        
        // Update percentage display
        pctEl.textContent = `${freq.toFixed(1)}%`;
        pctEl.className = 'digit-pct';
        if (isColdest) {
            pctEl.classList.add('coldest');
        } else if (isValid) {
            pctEl.classList.add('cold');
        }
        
        // Update box classes
        box.classList.remove('valid', 'coldest', 'selected');
        
        // Apply selected state first (highest priority for visual)
        if (isSelected) {
            box.classList.add('selected');
        }
        
        // Apply coldest/valid states
        if (isColdest) {
            box.classList.add('coldest');
            statusEl.textContent = '‚ùÑÔ∏è COLDEST';
            statusEl.className = 'digit-status coldest';
        } else if (isValid) {
            box.classList.add('valid');
            statusEl.textContent = 'VALID';
            statusEl.className = 'digit-status';
        } else {
            statusEl.textContent = '';
            statusEl.className = 'digit-status';
        }
    }
    
    updateAutoStatus();
    updateManualButtons();
}

// =============================================
// MODE CONTROL
// =============================================
function setMode(mode) {
    state.mode = mode;
    
    document.getElementById('modeAuto').classList.toggle('active', mode === 'auto');
    document.getElementById('modeManual').classList.toggle('active', mode === 'manual');
    
    document.getElementById('autoSection').style.display = mode === 'auto' ? 'block' : 'none';
    document.getElementById('manualSection').style.display = mode === 'manual' ? 'block' : 'none';
    
    if (mode === 'manual') stopAuto();
    
    log(`Switched to ${mode.toUpperCase()} mode`, 'info');
}

// =============================================
// AUTO MODE
// =============================================
function updateAutoStatus() {
    const statusEl = document.getElementById('autoStatus');
    const startBtn = document.getElementById('startAutoBtn');
    const stopBtn = document.getElementById('stopAutoBtn');
    const ticksToAnalyze = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    const coldThreshold = parseFloat(document.getElementById('coldThreshold').value) || 5.5;
    
    // Get enabled strategies
    const stratCold = document.getElementById('stratCold')?.checked;
    const stratDouble = document.getElementById('stratDouble')?.checked;
    const stratDoubleCold = document.getElementById('stratDoubleCold')?.checked;
    const stratTripleCold = document.getElementById('stratTripleCold')?.checked;
    
    // Update strategy status display
    const strategyStatusEl = document.getElementById('strategyStatus');
    const enabledStrategies = [];
    if (stratCold) enabledStrategies.push('‚ùÑÔ∏è Cold');
    if (stratDouble) enabledStrategies.push('üî• Double');
    if (stratDoubleCold) enabledStrategies.push('üî•‚ùÑÔ∏è Dbl+Cold');
    if (stratTripleCold) enabledStrategies.push('üî•üî•üî•‚ùÑÔ∏è Trpl+Cold');
    
    if (strategyStatusEl) {
        if (enabledStrategies.length === 0) {
            strategyStatusEl.textContent = 'Select at least one strategy';
            strategyStatusEl.style.color = 'var(--red)';
        } else {
            strategyStatusEl.textContent = `Active: ${enabledStrategies.join(' | ')}`;
            strategyStatusEl.style.color = 'var(--green)';
        }
    }
    
    if (state.ticks.length < ticksToAnalyze) {
        statusEl.className = 'auto-status';
        statusEl.innerHTML = `
            <div class="auto-icon">‚è≥</div>
            <div class="auto-text">Collecting ticks...</div>
            <div class="auto-sub">${state.ticks.length}/${ticksToAnalyze} ticks</div>
        `;
        startBtn.style.display = 'none';
        stopBtn.style.display = 'none';
        return;
    }
    
    // Check how many digits are under cold threshold (use coldThreshold for display)
    const recent = state.ticks.slice(-ticksToAnalyze);
    const counts = [0,0,0,0,0,0,0,0,0,0];
    recent.forEach(t => counts[t.digit]++);
    const coldDigits = [];
    for (let i = 0; i < 10; i++) {
        const freq = counts[i] / recent.length * 100;
        if (freq <= coldThreshold) {
            coldDigits.push({ digit: i, freq: freq });
        }
    }
    
    if (!state.autoRunning) {
        let readyText = '';
        if (enabledStrategies.length === 0) {
            readyText = 'Select strategies above';
        } else {
            const parts = [];
            if (stratCold || stratDoubleCold || stratTripleCold) {
                parts.push(`${coldDigits.length} cold digit(s)`);
            }
            if (stratDouble) {
                parts.push('watching doubles');
            }
            readyText = parts.join(' + ') || 'Ready';
        }
        
        statusEl.className = 'auto-status ready';
        statusEl.innerHTML = `
            <div class="auto-icon">‚úÖ</div>
            <div class="auto-text">Ready</div>
            <div class="auto-sub">${readyText}</div>
        `;
        startBtn.style.display = enabledStrategies.length > 0 ? 'block' : 'none';
        stopBtn.style.display = 'none';
    } else {
        if (state.tradePending) {
            statusEl.className = 'auto-status watching';
            statusEl.innerHTML = `
                <div class="auto-icon">‚ö°</div>
                <div class="auto-text">Trade Pending...</div>
                <div class="auto-sub">Processing DIFFERS on digit ${state.currentTarget}</div>
            `;
        } else if (state.doubleDetected && (stratDouble || stratDoubleCold)) {
            statusEl.className = 'auto-status watching';
            statusEl.innerHTML = `
                <div class="auto-icon">üî•</div>
                <div class="auto-text">DOUBLE DETECTED!</div>
                <div class="auto-sub">Digit ${state.doubleDigit} appeared twice</div>
            `;
        } else {
            statusEl.className = 'auto-status watching';
            statusEl.innerHTML = `
                <div class="auto-icon">üëÅÔ∏è</div>
                <div class="auto-text">Watching...</div>
                <div class="auto-sub">${enabledStrategies.join(' | ')}</div>
            `;
        }
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
    }
}

function startAuto() {
    const ticksToAnalyze = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    
    // Get individual thresholds
    const coldThreshold = parseFloat(document.getElementById('coldThreshold').value) || 5.5;
    const doubleColdThreshold = parseFloat(document.getElementById('doubleColdThreshold').value) || 7;
    const tripleColdThreshold = parseFloat(document.getElementById('tripleColdThreshold').value) || 9;
    
    // Get enabled strategies
    const stratCold = document.getElementById('stratCold')?.checked;
    const stratDouble = document.getElementById('stratDouble')?.checked;
    const stratDoubleCold = document.getElementById('stratDoubleCold')?.checked;
    const stratTripleCold = document.getElementById('stratTripleCold')?.checked;
    const enableTripleRecovery = document.getElementById('enableTripleRecovery')?.checked;
    
    // Validate at least one strategy
    if (!stratCold && !stratDouble && !stratDoubleCold && !stratTripleCold) {
        return log('‚ùå Select at least one strategy!', 'loss');
    }
    
    if (state.ticks.length < ticksToAnalyze) return log(`Need ${ticksToAnalyze} ticks first!`, 'loss');
    
    state.autoRunning = true;
    state.tradePending = false;
    state.lastPriceDigit = null; // Reset for fresh double detection
    state.consecutiveCount = 1;
    state.waitingForTriple = false;
    state.lastTradedDigit = null;
    
    // Build strategy list for log with individual thresholds
    const strategies = [];
    if (stratCold) strategies.push(`‚ùÑÔ∏è Cold (‚â§${coldThreshold}%)`);
    if (stratDouble) {
        let doubleText = `üî• Double (${state.doubleRapidCount}x)`;
        if (enableTripleRecovery) doubleText += ' +Recovery';
        strategies.push(doubleText);
    }
    if (stratDoubleCold) strategies.push(`üî•‚ùÑÔ∏è Dbl+Cold (‚â§${doubleColdThreshold}%)`);
    if (stratTripleCold) strategies.push(`üî•üî•üî•‚ùÑÔ∏è Trpl+Cold (‚â§${tripleColdThreshold}%)`);
    
    log(`ü§ñ Auto started: ${strategies.join(' | ')}`, 'info');
    updateAutoStatus();
}

function stopAuto() {
    state.autoRunning = false;
    state.tradePending = false;
    state.currentTarget = null;
    state.doubleDetected = false;
    state.doubleDigit = null;
    state.consecutiveCount = 1;
    state.waitingForTriple = false;
    state.lastTradedDigit = null;
    log('‚èπÔ∏è Auto stopped', 'info');
    updateAutoStatus();
}

function updateStrategyDisplay() {
    // No longer needed - individual thresholds are now inline
    updateAutoStatus();
}

function toggleDoubleOptions() {
    const stratDouble = document.getElementById('stratDouble')?.checked;
    const optionsSection = document.getElementById('doubleOptionsSection');
    if (optionsSection) {
        optionsSection.style.display = stratDouble ? 'block' : 'none';
    }
    updateAutoStatus();
}

function setDoubleRapid(count) {
    state.doubleRapidCount = count;
    
    // Update button states
    document.querySelectorAll('.rapid-opt').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(count)) {
            btn.classList.add('active');
        }
    });
    
    updateAutoStatus();
    log(`üî• Double rapid set to ${count} trade(s)`, 'info');
}

function triggerAutoTrade(digit, freq, reason, useDoubleRapid = false) {
    state.tradePending = true;
    
    const stratDouble = document.getElementById('stratDouble')?.checked;
    const enableTripleRecovery = document.getElementById('enableTripleRecovery')?.checked;
    const rapidCount = useDoubleRapid ? state.doubleRapidCount : 1;
    
    // If double strategy trade and triple recovery enabled, watch for triple
    if (useDoubleRapid && stratDouble && enableTripleRecovery) {
        state.waitingForTriple = true;
        state.lastTradedDigit = digit;
    }
    
    log(`üîî ${reason}! Digit ${digit} - Trading DIFFERS...`, 'trade');
    
    state.triggers.push({
        time: getTimestamp(),
        digit: digit,
        freq: freq,
        reason: reason
    });
    updateTriggerHistory();
    
    // Place trades (rapid if double strategy with count > 1)
    if (rapidCount > 1) {
        // Rapid fire trades for double strategy
        for (let i = 0; i < rapidCount; i++) {
            setTimeout(() => {
                placeTrade(digit);
                if (i > 0) log(`üî• Rapid trade ${i + 1}/${rapidCount} on digit ${digit}`, 'trade');
            }, i * 300); // 300ms between trades
        }
        
        // Reset tradePending after all trades (but keep waitingForTriple!)
        setTimeout(() => {
            state.tradePending = false;
            state.doubleDetected = false;
            state.doubleDigit = null;
            if (state.autoRunning) {
                updateAutoStatus();
            }
        }, rapidCount * 300 + 2000);
    } else {
        // Single trade
        placeTrade(digit);
        
        // Reset tradePending after trade processes (but keep waitingForTriple!)
        setTimeout(() => {
            state.tradePending = false;
            state.doubleDetected = false;
            state.doubleDigit = null;
            if (state.autoRunning) {
                updateAutoStatus();
            }
        }, 2000);
    }
}

// =============================================
// MANUAL MODE
// =============================================
function selectDigit(d) {
    state.selectedDigit = d;
    document.querySelectorAll('.digit-box').forEach(box => box.classList.remove('selected'));
    document.getElementById(`digit-${d}`).classList.add('selected');
    document.getElementById('selectedDigitDisplay').textContent = d;
    updateManualButtons();
    log(`Selected digit ${d} for manual trading`, 'info');
}

function updateManualButtons() {
    // Buttons always enabled - user can trade anytime
}

function setRapidCount(count) {
    state.rapidCount = count;
    document.getElementById('rapidCount').value = count;
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === String(count));
    });
    updateRapidLabel();
}

function updateRapidLabel() {
    document.getElementById('rapidLabel').textContent = `(${state.rapidCount} trades)`;
}

function placeSingleTrade() {
    if (!state.connected) {
        log('Connect first!', 'loss');
        return;
    }
    
    // If no digit selected, use coldest valid or default to 0
    let digit = state.selectedDigit;
    if (digit === null) {
        if (state.validTargets.length > 0) {
            state.validTargets.sort((a, b) => a.freq - b.freq);
            digit = state.validTargets[0].digit;
            log(`No digit selected, using coldest: ${digit}`, 'alert');
        } else {
            digit = 0;
            log(`No digit selected, using default: 0`, 'alert');
        }
        state.selectedDigit = digit;
        document.getElementById('selectedDigitDisplay').textContent = digit;
        document.getElementById(`digit-${digit}`).classList.add('selected');
    }
    
    log(`üéØ Single: DIFFERS on digit ${digit}`, 'trade');
    placeTrade(digit);
}

function placeRapidFire() {
    if (!state.connected) {
        log('Connect first!', 'loss');
        return;
    }
    
    if (state.rapidInProgress) {
        log('Rapid fire already in progress!', 'alert');
        return;
    }
    
    // If no digit selected, use coldest valid or default to 0
    let digit = state.selectedDigit;
    if (digit === null) {
        if (state.validTargets.length > 0) {
            state.validTargets.sort((a, b) => a.freq - b.freq);
            digit = state.validTargets[0].digit;
            log(`No digit selected, using coldest: ${digit}`, 'alert');
        } else {
            digit = 0;
            log(`No digit selected, using default: 0`, 'alert');
        }
        state.selectedDigit = digit;
        document.getElementById('selectedDigitDisplay').textContent = digit;
        document.getElementById(`digit-${digit}`).classList.add('selected');
    }
    
    state.rapidInProgress = true;
    state.rapidResults = [];
    state.rapidTradesPlaced = 0;
    state.rapidWins = 0;
    state.rapidLosses = 0;
    state.rapidPL = 0;
    
    document.getElementById('rapidStats').style.display = 'grid';
    document.getElementById('ticker').innerHTML = '';
    
    log(`üî• Rapid: ${state.rapidCount} DIFFERS on digit ${digit}`, 'trade');
    
    let fired = 0;
    const interval = setInterval(() => {
        if (fired >= state.rapidCount || !state.rapidInProgress) {
            clearInterval(interval);
            return;
        }
        placeTrade(state.selectedDigit);
        fired++;
    }, 150);
}

// =============================================
// TRADE EXECUTION
// =============================================
function placeTrade(digit) {
    const stake = parseFloat(document.getElementById('stake').value);
    const ticks = parseInt(document.getElementById('ticks').value);
    const symbol = document.getElementById('symbol').value;
    
    state.ws.send(JSON.stringify({
        proposal: 1,
        amount: stake.toFixed(2),
        basis: 'stake',
        contract_type: 'DIGITDIFF',
        currency: 'USD',
        duration: ticks,
        duration_unit: 't',
        symbol: symbol,
        barrier: String(digit)
    }));
}

function handleResult(contract) {
    const info = state.pendingContracts.get(contract.contract_id);
    if (!info) return;
    state.pendingContracts.delete(contract.contract_id);
    
    const profit = contract.profit;
    const isWin = profit > 0;
    
    state.totalStats.trades++;
    if (isWin) state.totalStats.wins++;
    state.totalStats.pl += profit;
    
    // Update win streak
    if (isWin) {
        state.currentStreak++;
        if (state.currentStreak > state.bestStreak) {
            state.bestStreak = state.currentStreak;
        }
    } else {
        state.currentStreak = 0;
    }
    updateStreakDisplay();
    
    state.trades.push({
        time: getTimestamp(),
        digit: info.digit,
        stake: info.stake,
        result: isWin ? 'WIN' : 'LOSS',
        profit: profit
    });
    
    if (info.isRapid && state.rapidInProgress) {
        if (isWin) state.rapidWins++;
        else state.rapidLosses++;
        state.rapidPL += profit;
        
        const idx = state.rapidResults.indexOf('pending');
        if (idx >= 0) state.rapidResults[idx] = isWin ? 'win' : 'loss';
        
        updateRapidDisplay();
        
        if (state.rapidWins + state.rapidLosses >= state.rapidCount) {
            state.rapidInProgress = false;
            log(`üî• Rapid done: ${state.rapidWins}W/${state.rapidLosses}L, P/L: $${state.rapidPL.toFixed(2)}`, 'info');
        }
    }
    
    log(isWin ? `‚úÖ WIN +$${profit.toFixed(2)}` : `‚ùå LOSS -$${Math.abs(profit).toFixed(2)}`, isWin ? 'win' : 'loss');
    
    updateTotalStats();
    updateTradeHistory();
    saveSettings();
}

// =============================================
// UI UPDATES
// =============================================
function updateRapidDisplay() {
    document.getElementById('rapidTrades').textContent = state.rapidTradesPlaced;
    document.getElementById('rapidWins').textContent = state.rapidWins;
    document.getElementById('rapidLosses').textContent = state.rapidLosses;
    
    const plEl = document.getElementById('rapidPL');
    plEl.textContent = `$${state.rapidPL >= 0 ? '+' : ''}${state.rapidPL.toFixed(2)}`;
    plEl.className = 'stat-val ' + (state.rapidPL >= 0 ? 'pos' : 'neg');
    
    document.getElementById('ticker').innerHTML = state.rapidResults.map(r => 
        `<div class="tick ${r}">${r === 'win' ? '‚úì' : r === 'loss' ? '‚úó' : '?'}</div>`
    ).join('');
}

function updateTotalStats() {
    document.getElementById('totalTrades').textContent = state.totalStats.trades;
    document.getElementById('totalWins').textContent = state.totalStats.wins;
    document.getElementById('winRate').textContent = 
        state.totalStats.trades > 0 ? `${(state.totalStats.wins / state.totalStats.trades * 100).toFixed(1)}%` : '0%';
    
    const plEl = document.getElementById('totalPL');
    plEl.textContent = `$${state.totalStats.pl >= 0 ? '+' : ''}${state.totalStats.pl.toFixed(2)}`;
    plEl.className = 'stat-val ' + (state.totalStats.pl >= 0 ? 'pos' : 'neg');
}

function updateStreakDisplay() {
    const streakEl = document.getElementById('streakDisplay');
    const bestEl = document.getElementById('bestStreakDisplay');
    
    // Current streak with fire emojis based on length
    let fireEmoji = '';
    if (state.currentStreak >= 10) fireEmoji = ' üî•üî•üî•';
    else if (state.currentStreak >= 5) fireEmoji = ' üî•üî•';
    else if (state.currentStreak >= 1) fireEmoji = ' üî•';
    
    streakEl.textContent = state.currentStreak + fireEmoji;
    streakEl.style.color = state.currentStreak >= 5 ? 'var(--green)' : 
                          state.currentStreak >= 1 ? 'var(--yellow)' : 'var(--muted)';
    
    // Best streak
    bestEl.textContent = state.bestStreak;
}

function updateTradeHistory() {
    document.getElementById('trades').innerHTML = state.trades.slice(-30).reverse().map(t => 
        `<div class="trade-row ${t.result.toLowerCase()}">
            <span>D${t.digit} | $${t.stake}</span>
            <span>${t.profit >= 0 ? '+' : ''}$${t.profit.toFixed(2)}</span>
        </div>`
    ).join('') || '<div style="text-align:center;color:var(--muted)">No trades</div>';
}

function updateTriggerHistory() {
    document.getElementById('triggers').innerHTML = state.triggers.slice(-20).reverse().map(t => 
        `<div class="trade-row">
            <span>Digit ${t.digit} (${t.freq.toFixed(1)}%)</span>
            <span style="color:var(--muted)">${t.time.split(', ')[1]}</span>
        </div>`
    ).join('') || '<div style="text-align:center;color:var(--muted)">No triggers</div>';
}

// =============================================
// EXPORT
// =============================================
function exportCSV() {
    if (!state.trades.length) return alert('No trades!');
    let csv = 'Time,Digit,Stake,Result,Profit\n';
    state.trades.forEach(t => csv += `"${t.time}",${t.digit},${t.stake},${t.result},${t.profit.toFixed(2)}\n`);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
    a.download = `cold_digit_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
}

function resetStats() {
    if (!confirm('Reset stats?')) return;
    state.trades = [];
    state.triggers = [];
    state.totalStats = { trades: 0, wins: 0, pl: 0 };
    state.currentStreak = 0;
    state.bestStreak = 0;
    saveSettings();
    updateTotalStats();
    updateStreakDisplay();
    updateTradeHistory();
    updateTriggerHistory();
    log('Stats reset', 'info');
}
</script>
</body>
</html>
