<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Triple Bounce v4 - Auto Cycle</title>
    <style>
        :root{--bg:#0a0e17;--card:#1a2235;--border:#2a3549;--text:#f1f5f9;--muted:#64748b;--green:#10b981;--red:#ef4444;--cyan:#06b6d4;--yellow:#f59e0b;--purple:#a855f7;--orange:#f97316}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);padding:10px;font-size:13px}
        .container{max-width:900px;margin:0 auto}
        
        .header{text-align:center;padding:15px;border-bottom:3px solid var(--purple);margin-bottom:15px}
        .header h1{font-size:26px;color:var(--purple);margin-bottom:5px}
        .header .subtitle{color:var(--green);font-size:12px;font-weight:600}
        
        .phase-banner{padding:20px;border-radius:10px;text-align:center;margin-bottom:15px;transition:all 0.3s}
        .phase-banner.observe{background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(245,158,11,0.1));border:3px solid var(--yellow)}
        .phase-banner.trade{background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(16,185,129,0.1));border:3px solid var(--green);animation:tradePulse 1s infinite}
        .phase-banner.cooldown{background:linear-gradient(135deg,rgba(6,182,212,0.2),rgba(6,182,212,0.1));border:3px solid var(--cyan)}
        .phase-banner.stopped{background:linear-gradient(135deg,rgba(100,116,139,0.2),rgba(100,116,139,0.1));border:3px solid var(--muted)}
        @keyframes tradePulse{0%,100%{box-shadow:0 0 0 rgba(16,185,129,0)}50%{box-shadow:0 0 30px rgba(16,185,129,0.3)}}
        
        .phase-icon{font-size:40px;margin-bottom:8px}
        .phase-title{font-size:22px;font-weight:700;margin-bottom:5px}
        .phase-sub{font-size:13px;color:var(--muted)}
        .phase-timer{font-family:monospace;font-size:28px;font-weight:700;margin-top:10px;color:var(--cyan)}
        
        .status-bar{display:flex;justify-content:center;align-items:center;gap:15px;padding:12px;background:var(--card);border-radius:8px;margin-bottom:15px;flex-wrap:wrap}
        .status-item{text-align:center;min-width:70px}
        .status-item .label{font-size:9px;color:var(--muted);text-transform:uppercase}
        .status-item .value{font-size:15px;font-weight:700;font-family:monospace}
        .dot{width:10px;height:10px;border-radius:50%;background:var(--muted);display:inline-block}
        .dot.on{background:var(--green);box-shadow:0 0 10px var(--green)}
        
        .card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:15px;margin-bottom:12px}
        .card h3{font-size:11px;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}
        .card.highlight{border:2px solid var(--purple);background:rgba(168,85,247,0.08)}
        
        .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
        .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
        
        label{display:block;font-size:10px;color:var(--muted);margin-bottom:3px}
        input,select{width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:12px}
        
        button{padding:12px 15px;border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:12px;text-transform:uppercase;transition:all 0.2s}
        .btn-blue{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;width:100%}
        .btn-green{background:var(--green);color:white}
        .btn-red{background:var(--red);color:white}
        .btn-purple{background:var(--purple);color:white}
        .btn-yellow{background:var(--yellow);color:#000}
        .btn-orange{background:var(--orange);color:white}
        
        .digit-display{text-align:center;padding:15px;background:var(--bg);border-radius:10px;margin:10px 0}
        .current-digit{font-size:60px;font-weight:900;line-height:1;transition:all 0.2s}
        .streak-indicator{font-size:18px;margin-top:8px;font-weight:600}
        .streak-indicator.triple{color:var(--purple);animation:pulse 0.5s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        
        .digit-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin:10px 0}
        .digit-box{background:var(--bg);border:2px solid var(--border);border-radius:6px;padding:8px 4px;text-align:center;transition:all 0.2s}
        .digit-box.active{border-color:var(--yellow);background:rgba(245,158,11,0.2)}
        .digit-box.tripled{border-color:var(--purple);background:rgba(168,85,247,0.4);animation:glow 0.5s infinite}
        @keyframes glow{0%,100%{box-shadow:0 0 5px var(--purple)}50%{box-shadow:0 0 20px var(--purple)}}
        .digit-num{font-size:18px;font-weight:700}
        .digit-freq{font-size:9px;color:var(--muted)}
        
        .cycle-stats{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:15px}
        .cycle-stat{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center}
        .cycle-stat .val{font-size:24px;font-weight:700;font-family:monospace}
        .cycle-stat .val.green{color:var(--green)}
        .cycle-stat .val.red{color:var(--red)}
        .cycle-stat .val.cyan{color:var(--cyan)}
        .cycle-stat .val.yellow{color:var(--yellow)}
        .cycle-stat .lbl{font-size:9px;color:var(--muted);text-transform:uppercase;margin-top:4px}
        
        .progress-bar{height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-top:10px}
        .progress-fill{height:100%;border-radius:4px;transition:width 0.3s}
        .progress-fill.green{background:var(--green)}
        .progress-fill.cyan{background:var(--cyan)}
        .progress-fill.yellow{background:var(--yellow)}
        
        .trade-log{max-height:200px;overflow-y:auto;background:var(--bg);border-radius:6px;padding:8px}
        .trade-entry{display:flex;justify-content:space-between;padding:8px;margin-bottom:4px;border-radius:5px;font-size:11px;border-left:4px solid var(--border)}
        .trade-entry.win{border-left-color:var(--green);background:rgba(16,185,129,0.1)}
        .trade-entry.loss{border-left-color:var(--red);background:rgba(239,68,68,0.1)}
        
        .activity-log{max-height:150px;overflow-y:auto;font-family:monospace;font-size:10px;background:var(--bg);padding:8px;border-radius:6px}
        .activity-log div{padding:2px 0;border-bottom:1px solid var(--border)}
        .activity-log .win{color:var(--green)}
        .activity-log .loss{color:var(--red)}
        .activity-log .info{color:var(--cyan)}
        .activity-log .alert{color:var(--yellow)}
        .activity-log .trade{color:var(--purple);font-weight:bold}
        .activity-log .cooldown{color:var(--cyan)}
        
        .cycle-indicator{display:flex;align-items:center;justify-content:center;gap:5px;margin-top:10px}
        .cycle-dot{width:12px;height:12px;border-radius:50%;background:var(--border)}
        .cycle-dot.complete{background:var(--green)}
        .cycle-dot.current{background:var(--yellow);animation:pulse 1s infinite}

        /* Exit overlay */
        .exit-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:9999;justify-content:center;align-items:center}
        .exit-overlay.show{display:flex}
        .exit-modal{background:var(--card);border:2px solid var(--purple);border-radius:16px;padding:30px;max-width:420px;width:90%;text-align:center}
        .exit-modal h2{color:var(--purple);margin-bottom:10px;font-size:20px}
        .exit-modal p{color:var(--muted);margin-bottom:20px;font-size:13px}
        .exit-modal .data-summary{background:var(--bg);border-radius:8px;padding:12px;margin-bottom:20px;font-family:monospace;font-size:11px;text-align:left}
        .exit-modal .data-summary div{padding:3px 0;display:flex;justify-content:space-between}
        .exit-modal .data-summary .val{color:var(--cyan);font-weight:700}
        .exit-modal .btn-row{display:flex;gap:10px}
        .exit-modal .btn-row button{flex:1}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéØ Triple Bounce v4</h1>
        <div class="subtitle">üîÑ Auto Cycle: Observe ‚Üí Trade ‚Üí Cooldown ‚Üí Repeat</div>
    </div>
    
    <!-- Phase Banner -->
    <div class="phase-banner stopped" id="phaseBanner">
        <div class="phase-icon" id="phaseIcon">‚èπ</div>
        <div class="phase-title" id="phaseTitle">BOT STOPPED</div>
        <div class="phase-sub" id="phaseSub">Connect and start to begin cycling</div>
        <div class="phase-timer" id="phaseTimer" style="display:none">00:00</div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item">
            <div class="label">Status</div>
            <div class="value"><span class="dot" id="dot"></span> <span id="status">Offline</span></div>
        </div>
        <div class="status-item">
            <div class="label">Balance</div>
            <div class="value" id="balance" style="color:var(--green)">$0.00</div>
        </div>
        <div class="status-item">
            <div class="label">Cycle</div>
            <div class="value" id="cycleNum" style="color:var(--purple)">#0</div>
        </div>
        <div class="status-item">
            <div class="label">Market</div>
            <div class="value" id="marketDisplay">--</div>
        </div>
        <div class="status-item">
            <div class="label">Ticks</div>
            <div class="value" id="tickCount">0</div>
        </div>
    </div>
    
    <!-- Cycle Stats -->
    <div class="cycle-stats">
        <div class="cycle-stat">
            <div class="val cyan" id="totalCycles">0</div>
            <div class="lbl">Cycles</div>
        </div>
        <div class="cycle-stat">
            <div class="val" id="totalTrades">0</div>
            <div class="lbl">Trades</div>
        </div>
        <div class="cycle-stat">
            <div class="val green" id="wins">0</div>
            <div class="lbl">Wins</div>
        </div>
        <div class="cycle-stat">
            <div class="val" id="winRate">0%</div>
            <div class="lbl">Win Rate</div>
        </div>
        <div class="cycle-stat">
            <div class="val green" id="pnl">$0.00</div>
            <div class="lbl">P/L</div>
        </div>
    </div>
    
    <!-- Connection -->
    <div class="card">
        <h3>üîå Connection</h3>
        <div class="row">
            <div>
                <label>API Token</label>
                <input type="password" id="token" placeholder="Enter your Deriv API token">
            </div>
            <div>
                <label>Symbol</label>
                <select id="symbol">
                    <option value="1HZ10V" selected>Volatility 10 (1s)</option>
                    <option value="1HZ25V">Volatility 25 (1s)</option>
                    <option value="1HZ50V">Volatility 50 (1s)</option>
                    <option value="1HZ75V">Volatility 75 (1s)</option>
                    <option value="1HZ100V">Volatility 100 (1s)</option>
                </select>
            </div>
        </div>
        <div style="margin-top:10px">
            <button class="btn-blue" onclick="connect()" id="connectBtn">üîó Connect to Deriv</button>
        </div>
    </div>
    
    <!-- Cycle Settings -->
    <div class="card">
        <h3>üîÑ Cycle Settings</h3>
        <div class="row3">
            <div>
                <label>Trades Per Cycle</label>
                <input type="number" id="tradesPerCycle" value="12" min="1" max="20">
            </div>
            <div>
                <label>Cooldown (minutes)</label>
                <input type="number" id="cooldownMins" value="1" min="1" max="60">
            </div>
            <div>
                <label>Max Cycles (0=‚àû)</label>
                <input type="number" id="maxCycles" value="0" min="0">
            </div>
        </div>
        <div class="row" style="margin-top:10px">
            <div>
                <label>Stake ($)</label>
                <input type="number" id="stake" value="10" min="0.35" step="0.01">
            </div>
            <div>
                <label>Max Freq % (skip hot)</label>
                <input type="number" id="maxFreq" value="16" min="12" max="20" step="1">
            </div>
        </div>
        <div style="margin-top:10px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" id="stopOnLoss" style="width:auto">
                <span>Stop entire bot on first loss</span>
            </label>
        </div>
        <div style="margin-top:8px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" id="resetOnLoss" checked style="width:auto">
                <span>Reset cycle on loss (restart trade count to 0)</span>
            </label>
        </div>
    </div>
    
    <!-- Controls -->
    <div class="card">
        <h3>üéÆ Controls</h3>
        <div class="row3">
            <button class="btn-green" onclick="startBot()" id="startBtn">‚ñ∂Ô∏è START BOT</button>
            <button class="btn-yellow" onclick="skipPhase1()" id="skipBtn">‚è≠ SKIP PHASE 1</button>
            <button class="btn-red" onclick="stopBot()" id="stopBtn">‚èπ STOP BOT</button>
        </div>
    </div>
    
    <!-- Live Display -->
    <div class="card highlight">
        <div class="digit-display">
            <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:8px">
                <span>üí∞ <span id="displayBalance" style="color:var(--green);font-weight:700">$0.00</span></span>
                <span>üìä <span id="displayPair" style="color:var(--cyan);font-weight:700">--</span></span>
            </div>
            <div id="priceDisplay" style="font-size:12px;color:var(--muted);margin-bottom:5px">Price: -.-----</div>
            <div class="current-digit" id="currentDigit" style="color:var(--yellow)">-</div>
            <div class="streak-indicator" id="streakIndicator">Waiting for data...</div>
        </div>
        
        <div class="digit-grid" id="digitGrid"></div>
        
        <!-- Cycle Progress -->
        <div style="margin-top:15px;padding:10px;background:var(--bg);border-radius:6px">
            <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:5px">
                <span id="progressLabel">Cycle Progress</span>
                <span id="progressText">0/0 trades</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill green" id="progressFill" style="width:0%"></div>
            </div>
        </div>
    </div>
    
    <!-- Trade Log -->
    <div class="card">
        <h3>üí∞ Trade History</h3>
        <div class="trade-log" id="tradeLog">
            <div style="text-align:center;color:var(--muted);padding:20px">No trades yet</div>
        </div>
    </div>
    
    <!-- Activity Log -->
    <div class="card">
        <h3>üìã Activity Log</h3>
        <div class="activity-log" id="activityLog"></div>
    </div>
    
    <!-- Export -->
    <div class="card">
        <h3>üì• Export Data</h3>
        <div class="row4">
            <button class="btn-purple" onclick="exportTrades()">Trades</button>
            <button class="btn-purple" onclick="exportTicks()">Ticks</button>
            <button class="btn-purple" onclick="exportTripleAnalysis()">Triples</button>
            <button class="btn-purple" onclick="exportActivity()">Activity</button>
        </div>
        <div style="margin-top:10px">
            <button class="btn-orange" onclick="exportAll()" style="width:100%">üì¶ DOWNLOAD ALL SESSION DATA</button>
        </div>
    </div>
</div>

<!-- Exit Overlay -->
<div class="exit-overlay" id="exitOverlay">
    <div class="exit-modal">
        <h2>üìä Unsaved Session Data</h2>
        <p>You have session data that hasn't been downloaded recently. Save before leaving?</p>
        <div class="data-summary" id="exitDataSummary"></div>
        <div class="btn-row">
            <button class="btn-green" onclick="exportAllAndLeave()">üíæ Download & Leave</button>
            <button class="btn-red" onclick="confirmLeave()">üö™ Leave</button>
        </div>
        <div style="margin-top:10px">
            <button class="btn-purple" onclick="cancelLeave()" style="width:100%">‚Üê Stay on Page</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const state = {
    ws: null,
    connected: false,
    isRunning: false,
    phase: 'stopped',
    
    // Tick data (display buffer - last 500)
    ticks: [],
    recentDigits: [],
    frequencies: Array(10).fill(10),
    currentStreak: 1,
    lastDigit: null,
    
    // Full session tick archive (never trimmed)
    allSessionTicks: [],
    sessionStartTime: null,
    
    // Triple event tracking
    tripleEvents: [],
    pendingTripleEvent: null,
    lastTripleTickIndex: 0,
    lastQuadTickIndex: 0,
    digitTripleCounts: Array(10).fill(0),
    digitQuadCounts: Array(10).fill(0),
    
    // Observation
    observedTriple: null,
    
    // Trading
    pendingTrade: null,
    pendingContracts: new Map(),
    cycleTradeCount: 0,
    
    // Cooldown
    cooldownEndTime: null,
    cooldownInterval: null,
    
    // Overall stats
    totalCycles: 0,
    totalTrades: 0,
    wins: 0,
    losses: 0,
    pnl: 0,
    winStreak: 0,
    tradesSinceLoss: 0,
    lastTradeResult: null,
    
    // Export tracking
    lastDownloadTime: 0,
    userWantsToLeave: false,
    
    // Logs
    tradeLog: [],
    activityLog: []
};

// ============================================================
// INITIALIZATION
// ============================================================
function initDigitGrid() {
    const grid = document.getElementById('digitGrid');
    grid.innerHTML = '';
    for (let i = 0; i < 10; i++) {
        const box = document.createElement('div');
        box.className = 'digit-box';
        box.id = `digit-${i}`;
        box.innerHTML = `<div class="digit-num">${i}</div><div class="digit-freq" id="freq-${i}">10.0%</div>`;
        grid.appendChild(box);
    }
}
initDigitGrid();

setInterval(() => {
    if (state.phase === 'cooldown' && state.cooldownEndTime) {
        const remaining = Math.max(0, state.cooldownEndTime - Date.now());
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        document.getElementById('phaseTimer').textContent = 
            `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        
        const cooldownMins = parseInt(document.getElementById('cooldownMins').value) || 10;
        const totalMs = cooldownMins * 60 * 1000;
        const elapsed = totalMs - remaining;
        const pct = (elapsed / totalMs) * 100;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressFill').className = 'progress-fill cyan';
        
        if (remaining <= 0) endCooldown();
    }
}, 1000);

// ============================================================
// EXIT HANDLER
// ============================================================
function hasUnsavedData() {
    return state.allSessionTicks.length > 0 || state.tripleEvents.length > 0 || state.tradeLog.length > 0;
}

function recentlyDownloaded() {
    return (Date.now() - state.lastDownloadTime) < 2 * 60 * 1000;
}

window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedData() && !recentlyDownloaded() && !state.userWantsToLeave) {
        e.preventDefault();
        e.returnValue = '';
        showExitOverlay();
        return '';
    }
});

function showExitOverlay() {
    const summary = document.getElementById('exitDataSummary');
    const dur = state.sessionStartTime ? Math.floor((Date.now() - state.sessionStartTime) / 1000) : 0;
    const mins = Math.floor(dur / 60);
    const secs = dur % 60;
    
    summary.innerHTML = `
        <div><span>Session Duration</span><span class="val">${mins}m ${secs}s</span></div>
        <div><span>Total Ticks</span><span class="val">${state.allSessionTicks.length.toLocaleString()}</span></div>
        <div><span>Triple Events</span><span class="val">${state.tripleEvents.length}</span></div>
        <div><span>Trades</span><span class="val">${state.totalTrades}</span></div>
        <div><span>Win Rate</span><span class="val">${state.totalTrades > 0 ? (state.wins/state.totalTrades*100).toFixed(1) : 0}%</span></div>
        <div><span>P/L</span><span class="val" style="color:${state.pnl >= 0 ? 'var(--green)' : 'var(--red)'}">$${state.pnl.toFixed(2)}</span></div>
    `;
    document.getElementById('exitOverlay').classList.add('show');
}

function exportAllAndLeave() {
    exportAll();
    setTimeout(() => {
        state.userWantsToLeave = true;
        document.getElementById('exitOverlay').classList.remove('show');
    }, 500);
}

function confirmLeave() {
    state.userWantsToLeave = true;
    document.getElementById('exitOverlay').classList.remove('show');
}

function cancelLeave() {
    document.getElementById('exitOverlay').classList.remove('show');
}

// ============================================================
// LOGGING
// ============================================================
function log(msg, type = 'info') {
    const time = new Date().toLocaleTimeString('en-US', { hour12: false });
    const el = document.getElementById('activityLog');
    el.innerHTML = `<div class="${type}">[${time}] ${msg}</div>` + el.innerHTML;
    if (el.children.length > 150) el.removeChild(el.lastChild);
    state.activityLog.push({ time, message: msg, type });
}

// ============================================================
// CONNECTION
// ============================================================
function connect() {
    const token = document.getElementById('token').value;
    if (!token) return log('Please enter API token', 'alert');
    
    if (state.ws && state.ws.readyState === WebSocket.OPEN) state.ws.close();
    
    log('Connecting...', 'info');
    state.ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
    
    state.ws.onopen = () => {
        state.ws.send(JSON.stringify({ authorize: token }));
        setInterval(() => {
            if (state.ws?.readyState === WebSocket.OPEN) {
                state.ws.send(JSON.stringify({ ping: 1 }));
            }
        }, 25000);
    };
    
    state.ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.ping || data.pong) return;
        
        if (data.authorize) {
            state.connected = true;
            state.sessionStartTime = Date.now();
            document.getElementById('dot').classList.add('on');
            document.getElementById('status').textContent = 'Connected';
            document.getElementById('balance').textContent = '$' + parseFloat(data.authorize.balance).toFixed(2);
            document.getElementById('displayBalance').textContent = '$' + parseFloat(data.authorize.balance).toFixed(2);
            log('‚úÖ Connected!', 'win');
            subscribeTicks();
        }
        
        if (data.tick) processTick(data.tick);
        if (data.buy) handleBuyResponse(data);
        if (data.proposal_open_contract) handleContractUpdate(data.proposal_open_contract);
        if (data.balance) {
            document.getElementById('balance').textContent = '$' + parseFloat(data.balance.balance).toFixed(2);
            document.getElementById('displayBalance').textContent = '$' + parseFloat(data.balance.balance).toFixed(2);
        }
    };
    
    state.ws.onclose = () => {
        state.connected = false;
        document.getElementById('dot').classList.remove('on');
        document.getElementById('status').textContent = 'Disconnected';
        log('üî¥ Disconnected', 'loss');
    };
}

function subscribeTicks() {
    const symbol = document.getElementById('symbol').value;
    state.ws.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
    state.ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
    state.ws.send(JSON.stringify({ proposal_open_contract: 1, subscribe: 1 }));
    document.getElementById('marketDisplay').textContent = symbol;
    document.getElementById('displayPair').textContent = symbol;
    log(`üì° Subscribed to ${symbol}`, 'info');
}

// ============================================================
// TICK PROCESSING
// ============================================================
function processTick(tick) {
    const price = parseFloat(tick.quote);
    const digit = parseInt(tick.quote.toString().slice(-1));
    const prevDigit = state.lastDigit;
    
    // Display buffer
    state.ticks.push({ price, digit, epoch: tick.epoch });
    if (state.ticks.length > 500) state.ticks.shift();
    
    state.recentDigits.push(digit);
    if (state.recentDigits.length > 200) state.recentDigits.shift();
    
    // Rolling frequencies (last 100)
    const recent = state.recentDigits.slice(-100);
    const counts = Array(10).fill(0);
    recent.forEach(d => counts[d]++);
    state.frequencies = counts.map(c => (c / recent.length) * 100);
    
    // Streak calculation
    let streak = 1;
    for (let i = state.recentDigits.length - 2; i >= 0; i--) {
        if (state.recentDigits[i] === digit) streak++;
        else break;
    }
    state.currentStreak = streak;
    state.lastDigit = digit;
    
    // === FULL SESSION ARCHIVE ===
    const tickIndex = state.allSessionTicks.length;
    state.allSessionTicks.push({
        epoch: tick.epoch,
        price: price,
        digit: digit,
        prevDigit: prevDigit,
        streak: streak,
        freqs: [...state.frequencies],
        isTripleStart: (streak === 3),
        isQuad: (streak === 4),
        isQuintPlus: (streak >= 5),
        elapsed: state.sessionStartTime ? ((Date.now() - state.sessionStartTime) / 1000).toFixed(1) : '0'
    });
    
    // === TRIPLE EVENT TRACKING ===
    trackTripleEvent(digit, streak, tick.epoch, tickIndex, prevDigit);
    
    // Update UI
    updateDigitDisplay(digit, price, streak >= 3);
    document.getElementById('tickCount').textContent = state.allSessionTicks.length;
    
    // Phase logic
    if (!state.isRunning || state.phase === 'stopped' || state.phase === 'cooldown') return;
    
    if (state.phase === 'observe' && state.observedTriple) {
        checkObservationResult(digit);
    }
    
    if (!state.pendingTrade && streak >= 3) {
        handleTriple(digit, streak);
    }
}

// ============================================================
// TRIPLE EVENT TRACKING
// ============================================================
function trackTripleEvent(digit, streak, epoch, tickIndex, prevDigit) {
    
    if (streak === 3 && !state.pendingTripleEvent) {
        // === NEW TRIPLE ===
        state.digitTripleCounts[digit]++;
        
        const minFreq = Math.min(...state.frequencies);
        const maxFreq = Math.max(...state.frequencies);
        const coldDigits = state.frequencies.filter(f => f <= 8).length;
        const hotDigits = state.frequencies.filter(f => f >= 12).length;
        
        // Distribution entropy (uniformity measure)
        const entropy = -state.frequencies.reduce((sum, f) => {
            const p = f / 100;
            return sum + (p > 0 ? p * Math.log2(p) : 0);
        }, 0);
        
        // Sequence context
        const prev30 = state.recentDigits.slice(-33, -3);
        const last20 = state.recentDigits.slice(-23, -3);
        const uniqueIn20 = new Set(last20).size;
        
        // What digit came right before the triple started
        const digitBeforeTriple = prev30.length > 0 ? prev30[prev30.length - 1] : null;
        
        state.pendingTripleEvent = {
            id: state.tripleEvents.length + 1,
            epoch: epoch,
            time: new Date().toISOString(),
            digit: digit,
            digitBeforeTriple: digitBeforeTriple,
            
            // Frequency context
            digitFreq: state.frequencies[digit],
            allFreqs: [...state.frequencies],
            digitRank: [...state.frequencies].sort((a,b) => a-b).indexOf(state.frequencies[digit]) + 1,
            coldestDigit: state.frequencies.indexOf(minFreq),
            coldestFreq: minFreq,
            hottestDigit: state.frequencies.indexOf(maxFreq),
            hottestFreq: maxFreq,
            coldDigitCount: coldDigits,
            hotDigitCount: hotDigits,
            entropy: entropy,
            
            // Sequence context
            prev30Digits: prev30.join(''),
            uniqueDigitsInLast20: uniqueIn20,
            
            // Gap / temporal
            tickIndex: tickIndex,
            ticksSinceLastTriple: tickIndex - state.lastTripleTickIndex,
            ticksSinceLastQuad: tickIndex - state.lastQuadTickIndex,
            digitTripleCount: state.digitTripleCounts[digit],
            digitQuadCount: state.digitQuadCounts[digit],
            sessionElapsedSec: state.sessionStartTime ? Math.floor((Date.now() - state.sessionStartTime) / 1000) : 0,
            hourOfDay: new Date().getHours(),
            minuteOfHour: new Date().getMinutes(),
            
            // Trading context
            phase: state.phase,
            cycleNum: state.totalCycles,
            cycleTradeNum: state.cycleTradeCount,
            runningWinRate: state.totalTrades > 0 ? (state.wins / state.totalTrades * 100) : 0,
            currentWinStreak: state.winStreak,
            tradesSinceLoss: state.tradesSinceLoss,
            lastTradeResult: state.lastTradeResult,
            totalTradesAtTime: state.totalTrades,
            runningPnl: state.pnl,
            
            // Outcome (filled on resolution)
            maxStreak: 3,
            outcome: 'pending',
            nextDigit: null,
            resolutionEpoch: null,
            wasTradedOn: false,
            tradeProfit: null
        };
        
        state.lastTripleTickIndex = tickIndex;
        
    } else if (state.pendingTripleEvent) {
        if (digit === state.pendingTripleEvent.digit) {
            // Extending streak
            state.pendingTripleEvent.maxStreak = streak;
            if (streak === 4) {
                state.pendingTripleEvent.outcome = 'quad';
                state.digitQuadCounts[digit]++;
                state.lastQuadTickIndex = tickIndex;
            }
        } else {
            // Streak broke ‚Äî resolve
            if (state.pendingTripleEvent.outcome === 'pending') {
                state.pendingTripleEvent.outcome = 'bounce';
            }
            state.pendingTripleEvent.nextDigit = digit;
            state.pendingTripleEvent.resolutionEpoch = epoch;
            state.tripleEvents.push(state.pendingTripleEvent);
            state.pendingTripleEvent = null;
        }
    }
}

// ============================================================
// UI: Digit Display
// ============================================================
function updateDigitDisplay(digit, price, isTriple) {
    document.getElementById('priceDisplay').textContent = `Price: ${price.toFixed(5)}`;
    document.getElementById('currentDigit').textContent = digit;
    document.getElementById('currentDigit').style.color = isTriple ? 'var(--purple)' : 'var(--yellow)';
    
    const streakEl = document.getElementById('streakIndicator');
    if (isTriple) {
        streakEl.textContent = `üî• TRIPLE! (${state.currentStreak}x D${digit})`;
        streakEl.className = 'streak-indicator triple';
    } else if (state.currentStreak === 2) {
        streakEl.textContent = `‚ö° Double (2x D${digit})`;
        streakEl.className = 'streak-indicator';
        streakEl.style.color = 'var(--orange)';
    } else {
        streakEl.textContent = `Single (D${digit})`;
        streakEl.className = 'streak-indicator';
        streakEl.style.color = 'var(--muted)';
    }
    
    for (let i = 0; i < 10; i++) {
        const box = document.getElementById(`digit-${i}`);
        const freqEl = document.getElementById(`freq-${i}`);
        freqEl.textContent = state.frequencies[i].toFixed(1) + '%';
        box.className = 'digit-box';
        if (i === digit) box.classList.add(isTriple ? 'tripled' : 'active');
    }
}

// ============================================================
// PHASE: OBSERVATION
// ============================================================
function checkObservationResult(currentDigit) {
    const observed = state.observedTriple;
    if (currentDigit === observed.digit) {
        if (state.currentStreak >= 4) {
            log(`üí• QUAD! D${observed.digit} x${state.currentStreak} - Loss scenario observed!`, 'loss');
            state.observedTriple = null;
            startTradingPhase();
        }
    } else {
        log(`üëÅÔ∏è D${observed.digit} triple ‚Üí D${currentDigit} (would be WIN, still waiting for loss)`, 'info');
        state.observedTriple = null;
    }
}

function handleTriple(digit, streak) {
    const maxFreq = parseFloat(document.getElementById('maxFreq').value) || 16;
    const freq = state.frequencies[digit];
    
    if (freq >= maxFreq) {
        log(`‚ö†Ô∏è Triple D${digit} skipped (freq ${freq.toFixed(1)}% ‚â• ${maxFreq}%)`, 'alert');
        return;
    }
    
    if (state.phase === 'observe') {
        state.observedTriple = { digit, freq, streak };
        log(`üëÅÔ∏è OBSERVING: Triple D${digit} (${freq.toFixed(1)}%)...`, 'info');
        updatePhaseBanner();
    } else if (state.phase === 'trade') {
        const tradesPerCycle = parseInt(document.getElementById('tradesPerCycle').value) || 12;
        if (state.cycleTradeCount >= tradesPerCycle) { startCooldown(); return; }
        
        state.cycleTradeCount++;
        
        // Mark pending triple event as traded
        if (state.pendingTripleEvent && state.pendingTripleEvent.digit === digit) {
            state.pendingTripleEvent.wasTradedOn = true;
        }
        
        log(`üéØ TRADE #${state.cycleTradeCount}/${tradesPerCycle}: DIFFERS D${digit} (${freq.toFixed(1)}%)`, 'trade');
        placeTrade(digit, freq);
        updateProgress();
    }
}

// ============================================================
// SKIP PHASE 1
// ============================================================
function skipPhase1() {
    if (!state.connected) { log('Please connect first!', 'alert'); return; }
    if (state.ticks.length < 50) { log(`Need more ticks (${state.ticks.length}/50). Wait...`, 'alert'); return; }
    if (state.phase === 'trade') { log('‚ö†Ô∏è Already in trading phase', 'alert'); return; }
    
    if (!state.isRunning) {
        state.isRunning = true;
        document.getElementById('startBtn').disabled = true;
        log('‚ñ∂Ô∏è Bot started (skipping Phase 1)...', 'trade');
    } else {
        log('‚è≠ Skipping Phase 1 ‚Üí jumping to trading!', 'alert');
    }
    
    state.cooldownEndTime = null;
    document.getElementById('phaseTimer').style.display = 'none';
    startTradingPhase();
}

// ============================================================
// PHASE: TRADING
// ============================================================
function startTradingPhase() {
    state.phase = 'trade';
    state.cycleTradeCount = 0;
    state.totalCycles++;
    
    document.getElementById('cycleNum').textContent = '#' + state.totalCycles;
    document.getElementById('totalCycles').textContent = state.totalCycles;
    
    const tradesPerCycle = parseInt(document.getElementById('tradesPerCycle').value) || 12;
    log(`‚úÖ PHASE 2: Trading ${tradesPerCycle} trades (Cycle #${state.totalCycles})`, 'win');
    
    updatePhaseBanner();
    updateProgress();
}

function placeTrade(digit, freq) {
    const stake = parseFloat(document.getElementById('stake').value) || 1;
    state.pendingTrade = { digit, freq, stake, time: new Date().toISOString() };
    
    state.ws.send(JSON.stringify({
        buy: 1,
        price: stake,
        parameters: {
            amount: stake,
            basis: 'stake',
            contract_type: 'DIGITDIFF',
            currency: 'USD',
            duration: 1,
            duration_unit: 't',
            symbol: document.getElementById('symbol').value,
            barrier: digit.toString()
        }
    }));
}

function handleBuyResponse(data) {
    if (data.error) { log(`‚ùå Error: ${data.error.message}`, 'loss'); state.pendingTrade = null; return; }
    if (data.buy) {
        state.pendingContracts.set(data.buy.contract_id, state.pendingTrade);
        log(`üì§ Contract ${data.buy.contract_id} placed`, 'info');
    }
}

function handleContractUpdate(contract) {
    const info = state.pendingContracts.get(contract.contract_id);
    if (!info) return;
    if (contract.status !== 'won' && contract.status !== 'lost') return;
    
    state.pendingContracts.delete(contract.contract_id);
    state.pendingTrade = null;
    
    const won = contract.status === 'won';
    const profit = parseFloat(contract.profit) || (won ? info.stake * 0.0965 : -info.stake);
    
    state.totalTrades++;
    state.pnl += profit;
    state.lastTradeResult = won ? 'win' : 'loss';
    
    if (won) {
        state.wins++;
        state.winStreak++;
        state.tradesSinceLoss++;
        log(`‚úÖ WIN! D${info.digit} ‚Üí +$${profit.toFixed(2)} [${state.cycleTradeCount}/${document.getElementById('tradesPerCycle').value}]`, 'win');
        linkTradeToTripleEvent(info.digit, profit);
    } else {
        state.losses++;
        state.winStreak = 0;
        state.tradesSinceLoss = 0;
        log(`‚ùå LOSS! D${info.digit} became quad ‚Üí -$${Math.abs(profit).toFixed(2)}`, 'loss');
        linkTradeToTripleEvent(info.digit, profit);
        
        if (document.getElementById('stopOnLoss').checked) {
            log('üõë Stopping on loss (conservative mode)', 'alert');
            stopBot();
            return;
        }
        
        if (document.getElementById('resetOnLoss').checked && state.phase === 'trade') {
            const tradesPerCycle = parseInt(document.getElementById('tradesPerCycle').value) || 12;
            log(`üîÑ LOSS RESET: Was ${state.cycleTradeCount}/${tradesPerCycle} ‚Üí restarting cycle at 0/${tradesPerCycle}`, 'alert');
            state.cycleTradeCount = 0;
            addTradeEntry(info.digit, info.freq, won, profit);
            updateStats();
            updateProgress();
            updatePhaseBanner();
            return;
        }
    }
    
    addTradeEntry(info.digit, info.freq, won, profit);
    updateStats();
    
    const tradesPerCycle = parseInt(document.getElementById('tradesPerCycle').value) || 12;
    if (state.cycleTradeCount >= tradesPerCycle) {
        log(`üèÅ Cycle #${state.totalCycles} complete: ${state.cycleTradeCount} trades`, 'info');
        const maxCycles = parseInt(document.getElementById('maxCycles').value) || 0;
        if (maxCycles > 0 && state.totalCycles >= maxCycles) {
            log(`üéØ Max cycles (${maxCycles}) reached!`, 'win');
            stopBot();
            return;
        }
        startCooldown();
    }
}

function linkTradeToTripleEvent(digit, profit) {
    for (let i = state.tripleEvents.length - 1; i >= 0; i--) {
        const te = state.tripleEvents[i];
        if (te.digit === digit && te.wasTradedOn && te.tradeProfit === null) {
            te.tradeProfit = profit;
            return;
        }
    }
    if (state.pendingTripleEvent && state.pendingTripleEvent.digit === digit && state.pendingTripleEvent.wasTradedOn) {
        state.pendingTripleEvent.tradeProfit = profit;
    }
}

// ============================================================
// PHASE: COOLDOWN
// ============================================================
function startCooldown() {
    state.phase = 'cooldown';
    const cooldownMins = parseInt(document.getElementById('cooldownMins').value) || 10;
    state.cooldownEndTime = Date.now() + (cooldownMins * 60 * 1000);
    log(`‚ùÑÔ∏è COOLDOWN: ${cooldownMins} minutes before next cycle`, 'cooldown');
    document.getElementById('phaseTimer').style.display = 'block';
    document.getElementById('progressLabel').textContent = 'Cooldown Progress';
    document.getElementById('progressText').textContent = `${cooldownMins}:00 remaining`;
    updatePhaseBanner();
}

function endCooldown() {
    state.cooldownEndTime = null;
    document.getElementById('phaseTimer').style.display = 'none';
    log(`‚úÖ Cooldown complete! Starting new observation phase...`, 'win');
    startObservationPhase();
}

// ============================================================
// PHASE: OBSERVATION (Start)
// ============================================================
function startObservationPhase() {
    state.phase = 'observe';
    state.observedTriple = null;
    state.cycleTradeCount = 0;
    
    const tradesPerCycle = parseInt(document.getElementById('tradesPerCycle').value) || 12;
    document.getElementById('progressLabel').textContent = 'Cycle Progress';
    document.getElementById('progressText').textContent = `0/${tradesPerCycle} trades`;
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressFill').className = 'progress-fill yellow';
    
    log(`üëÅÔ∏è PHASE 1: Observing for quad (loss scenario)...`, 'info');
    updatePhaseBanner();
}

// ============================================================
// BOT CONTROLS
// ============================================================
function startBot() {
    if (!state.connected) { log('Please connect first!', 'alert'); return; }
    if (state.ticks.length < 50) { log(`Need more ticks (${state.ticks.length}/50). Wait...`, 'alert'); return; }
    
    state.isRunning = true;
    state.cycleTradeCount = 0;
    state.observedTriple = null;
    document.getElementById('startBtn').disabled = true;
    log('‚ñ∂Ô∏è Bot started! Beginning observation phase...', 'trade');
    startObservationPhase();
}

function stopBot() {
    state.isRunning = false;
    state.phase = 'stopped';
    state.pendingTrade = null;
    state.observedTriple = null;
    state.cooldownEndTime = null;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('phaseTimer').style.display = 'none';
    updatePhaseBanner();
    log('‚èπ Bot stopped', 'info');
}

// ============================================================
// UI UPDATES
// ============================================================
function updatePhaseBanner() {
    const banner = document.getElementById('phaseBanner');
    const icon = document.getElementById('phaseIcon');
    const title = document.getElementById('phaseTitle');
    const sub = document.getElementById('phaseSub');
    const timer = document.getElementById('phaseTimer');
    
    banner.className = 'phase-banner ' + state.phase;
    
    switch (state.phase) {
        case 'stopped':
            icon.textContent = '‚èπ'; title.textContent = 'BOT STOPPED';
            sub.textContent = 'Start to begin cycling'; timer.style.display = 'none'; break;
        case 'observe':
            icon.textContent = 'üëÅÔ∏è'; title.textContent = 'PHASE 1: OBSERVING';
            sub.textContent = state.observedTriple 
                ? `Watching D${state.observedTriple.digit} triple...`
                : 'Waiting to observe a quad (loss scenario)';
            timer.style.display = 'none'; break;
        case 'trade':
            const tpc = parseInt(document.getElementById('tradesPerCycle').value) || 12;
            icon.textContent = 'üéØ'; title.textContent = 'PHASE 2: TRADING';
            sub.textContent = `Trade ${state.cycleTradeCount}/${tpc} | Cycle #${state.totalCycles}`;
            timer.style.display = 'none'; break;
        case 'cooldown':
            icon.textContent = '‚ùÑÔ∏è'; title.textContent = 'PHASE 3: COOLDOWN';
            sub.textContent = 'Waiting before next cycle...'; timer.style.display = 'block'; break;
    }
}

function updateProgress() {
    const tradesPerCycle = parseInt(document.getElementById('tradesPerCycle').value) || 12;
    const pct = (state.cycleTradeCount / tradesPerCycle) * 100;
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressFill').className = 'progress-fill green';
    document.getElementById('progressText').textContent = `${state.cycleTradeCount}/${tradesPerCycle} trades`;
    updatePhaseBanner();
}

function updateStats() {
    document.getElementById('totalTrades').textContent = state.totalTrades;
    document.getElementById('wins').textContent = state.wins;
    document.getElementById('winRate').textContent = state.totalTrades > 0 
        ? (state.wins / state.totalTrades * 100).toFixed(1) + '%' : '0%';
    document.getElementById('pnl').textContent = '$' + state.pnl.toFixed(2);
    document.getElementById('pnl').className = 'val ' + (state.pnl >= 0 ? 'green' : 'red');
}

function addTradeEntry(digit, freq, won, profit) {
    const el = document.getElementById('tradeLog');
    if (state.totalTrades === 1) el.innerHTML = '';
    const entry = document.createElement('div');
    entry.className = `trade-entry ${won ? 'win' : 'loss'}`;
    entry.innerHTML = `
        <span>Cycle #${state.totalCycles} | D${digit} (${freq.toFixed(1)}%) - ${won ? 'WIN ‚úÖ' : 'LOSS ‚ùå'}</span>
        <span style="color:${won ? 'var(--green)' : 'var(--red)'}">${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}</span>
    `;
    el.insertBefore(entry, el.firstChild);
    state.tradeLog.push({ cycle: state.totalCycles, time: new Date().toISOString(), digit, freq: freq.toFixed(1), result: won ? 'WIN' : 'LOSS', profit: profit.toFixed(2) });
}

// ============================================================
// EXPORT FUNCTIONS
// ============================================================
function markDownloadTime() { state.lastDownloadTime = Date.now(); }

// --- Trades CSV ---
function exportTrades() {
    if (!state.tradeLog.length) return log('No trades to export', 'alert');
    const csv = ['cycle,time,digit,freq,result,profit', ...state.tradeLog.map(t => 
        `${t.cycle},${t.time},${t.digit},${t.freq},${t.result},${t.profit}`)].join('\n');
    download(csv, `tb4_trades_${Date.now()}.csv`);
    markDownloadTime();
    log('üì• Trades exported', 'info');
}

// --- Comprehensive Ticks CSV ---
function exportTicks() {
    if (!state.allSessionTicks.length) return log('No tick data to export', 'alert');
    
    const header = [
        'tick_num','epoch','elapsed_sec','price','digit','prev_digit','streak',
        'is_double','is_triple_start','is_quad','is_quint_plus',
        'freq_d0','freq_d1','freq_d2','freq_d3','freq_d4',
        'freq_d5','freq_d6','freq_d7','freq_d8','freq_d9',
        'digit_freq','digit_rank','coldest_digit','hottest_digit',
        'ticks_since_last_triple','ticks_since_last_quad'
    ].join(',');
    
    let lastTri = 0, lastQuad = 0;
    
    const rows = state.allSessionTicks.map((t, i) => {
        const f = t.freqs || Array(10).fill(10);
        const digitFreq = f[t.digit];
        const sorted = [...f].sort((a,b) => a - b);
        const rank = sorted.indexOf(f[t.digit]) + 1;
        const coldest = f.indexOf(Math.min(...f));
        const hottest = f.indexOf(Math.max(...f));
        const sinceTri = i - lastTri;
        const sinceQuad = i - lastQuad;
        if (t.isTripleStart) lastTri = i;
        if (t.isQuad) lastQuad = i;
        
        return [
            i, t.epoch, t.elapsed, t.price, t.digit,
            t.prevDigit !== null ? t.prevDigit : '',
            t.streak,
            t.streak === 2 ? 1 : 0,
            t.isTripleStart ? 1 : 0,
            t.isQuad ? 1 : 0,
            t.isQuintPlus ? 1 : 0,
            ...f.map(v => v.toFixed(1)),
            digitFreq.toFixed(1), rank, coldest, hottest,
            sinceTri, sinceQuad
        ].join(',');
    });
    
    download([header, ...rows].join('\n'), `tb4_ticks_${Date.now()}.csv`);
    markDownloadTime();
    log(`üì• Ticks exported (${state.allSessionTicks.length} ticks, 27 columns)`, 'info');
}

// --- Triple Analysis CSV (the gold data for pattern analysis) ---
function exportTripleAnalysis() {
    if (!state.tripleEvents.length) return log('No triple events to export', 'alert');
    
    const header = [
        'id','epoch','time','digit',
        'digit_freq','digit_rank',
        'freq_d0','freq_d1','freq_d2','freq_d3','freq_d4',
        'freq_d5','freq_d6','freq_d7','freq_d8','freq_d9',
        'coldest_digit','coldest_freq','hottest_digit','hottest_freq',
        'cold_digit_count','hot_digit_count','distribution_entropy',
        'digit_before_triple','prev_30_digits','unique_in_last_20',
        'tick_index','ticks_since_last_triple','ticks_since_last_quad',
        'digit_triple_count','digit_quad_count',
        'session_elapsed_sec','hour','minute',
        'phase','cycle_num','cycle_trade_num',
        'running_win_rate','win_streak','trades_since_loss',
        'last_trade_result','total_trades','running_pnl',
        'outcome','max_streak','next_digit',
        'was_traded','trade_profit'
    ].join(',');
    
    const rows = state.tripleEvents.map(te => {
        const f = te.allFreqs || Array(10).fill(10);
        const sorted = [...f].sort((a,b) => a - b);
        const rank = sorted.indexOf(f[te.digit]) + 1;
        
        return [
            te.id, te.epoch, te.time, te.digit,
            te.digitFreq.toFixed(1), rank,
            ...f.map(v => v.toFixed(1)),
            te.coldestDigit, te.coldestFreq.toFixed(1),
            te.hottestDigit, te.hottestFreq.toFixed(1),
            te.coldDigitCount, te.hotDigitCount, te.entropy.toFixed(3),
            te.digitBeforeTriple !== null ? te.digitBeforeTriple : '',
            te.prev30Digits,
            te.uniqueDigitsInLast20,
            te.tickIndex, te.ticksSinceLastTriple, te.ticksSinceLastQuad,
            te.digitTripleCount, te.digitQuadCount,
            te.sessionElapsedSec, te.hourOfDay, te.minuteOfHour,
            te.phase, te.cycleNum, te.cycleTradeNum,
            te.runningWinRate.toFixed(1), te.currentWinStreak, te.tradesSinceLoss,
            te.lastTradeResult || '', te.totalTradesAtTime, te.runningPnl.toFixed(2),
            te.outcome, te.maxStreak,
            te.nextDigit !== null ? te.nextDigit : '',
            te.wasTradedOn ? 1 : 0,
            te.tradeProfit !== null ? te.tradeProfit.toFixed(2) : ''
        ].join(',');
    });
    
    download([header, ...rows].join('\n'), `tb4_triples_${Date.now()}.csv`);
    markDownloadTime();
    log(`üì• Triple analysis exported (${state.tripleEvents.length} events, 45 features)`, 'info');
}

// --- Activity Log ---
function exportActivity() {
    if (!state.activityLog.length) return log('No activity to export', 'alert');
    const txt = state.activityLog.map(a => `[${a.time}] ${a.message}`).join('\n');
    download(txt, `tb4_activity_${Date.now()}.txt`);
    markDownloadTime();
    log('üì• Activity exported', 'info');
}

// --- Export All (session summary + all files) ---
function exportAll() {
    const ts = Date.now();
    let count = 0;
    
    // Session summary JSON
    const bounces = state.tripleEvents.filter(e => e.outcome === 'bounce').length;
    const quads = state.tripleEvents.filter(e => e.outcome === 'quad').length;
    
    const summary = {
        sessionStart: state.sessionStartTime ? new Date(state.sessionStartTime).toISOString() : null,
        sessionEnd: new Date().toISOString(),
        durationSec: state.sessionStartTime ? Math.floor((Date.now() - state.sessionStartTime) / 1000) : 0,
        symbol: document.getElementById('symbol').value,
        totalTicks: state.allSessionTicks.length,
        totalTriples: state.tripleEvents.length,
        totalBounces: bounces,
        totalQuads: quads,
        bounceRate: state.tripleEvents.length > 0 ? (bounces / state.tripleEvents.length * 100).toFixed(1) + '%' : 'N/A',
        totalTrades: state.totalTrades,
        wins: state.wins,
        losses: state.losses,
        winRate: state.totalTrades > 0 ? (state.wins / state.totalTrades * 100).toFixed(1) + '%' : 'N/A',
        pnl: state.pnl.toFixed(2),
        totalCycles: state.totalCycles,
        digitTripleCounts: Object.fromEntries(state.digitTripleCounts.map((c,i) => [`d${i}`, c])),
        digitQuadCounts: Object.fromEntries(state.digitQuadCounts.map((c,i) => [`d${i}`, c])),
        digitBounceRates: Object.fromEntries(state.digitTripleCounts.map((tc, i) => {
            const qc = state.digitQuadCounts[i];
            return [`d${i}`, tc > 0 ? ((tc - qc) / tc * 100).toFixed(1) + '%' : 'N/A'];
        })),
        settings: {
            tradesPerCycle: document.getElementById('tradesPerCycle').value,
            cooldownMins: document.getElementById('cooldownMins').value,
            stake: document.getElementById('stake').value,
            maxFreq: document.getElementById('maxFreq').value,
            resetOnLoss: document.getElementById('resetOnLoss').checked,
            stopOnLoss: document.getElementById('stopOnLoss').checked
        }
    };
    download(JSON.stringify(summary, null, 2), `tb4_summary_${ts}.json`);
    count++;
    
    if (state.allSessionTicks.length > 0) { exportTicks(); count++; }
    if (state.tripleEvents.length > 0) { exportTripleAnalysis(); count++; }
    if (state.tradeLog.length > 0) { exportTrades(); count++; }
    if (state.activityLog.length > 0) { exportActivity(); count++; }
    
    markDownloadTime();
    log(`üì¶ All session data exported (${count} files)`, 'win');
}

function download(content, filename) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], { type: 'text/plain' }));
    a.download = filename;
    a.click();
}

log('üéØ Triple Bounce v4 ready. Connect to start.', 'info');
</script>
</body>
</html>
