<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trend Signal Over/Under Bot</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-0: #06080c;
            --bg-1: #0c1018;
            --bg-2: #141a26;
            --bg-3: #1c2536;
            --green: #22c55e;
            --green-dim: #14532d;
            --red: #f43f5e;
            --red-dim: #4c0519;
            --blue: #38bdf8;
            --amber: #fbbf24;
            --purple: #a78bfa;
            --text-0: #f1f5f9;
            --text-1: #94a3b8;
            --text-2: #475569;
            --border: #1e293b;
            --glow-green: rgba(34, 197, 94, 0.15);
            --glow-red: rgba(244, 63, 94, 0.15);
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-0);
            color: var(--text-0);
            min-height: 100vh;
            padding: 16px;
        }
        
        .mono { font-family: 'IBM Plex Mono', monospace; }
        
        /* â”€â”€ HEADER â”€â”€ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-1);
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 16px;
        }
        
        .logo { display: flex; align-items: center; gap: 14px; }
        
        .logo-mark {
            width: 42px; height: 42px;
            background: linear-gradient(135deg, var(--green) 0%, var(--blue) 100%);
            border-radius: 11px;
            display: grid; place-items: center;
            font-weight: 800; font-size: 16px; color: var(--bg-0);
            letter-spacing: -0.5px;
        }
        
        .logo h1 { font-size: 1.35rem; font-weight: 700; letter-spacing: -0.3px; }
        .logo h1 em { font-style: normal; color: var(--green); }
        
        .header-stats { display: flex; gap: 14px; align-items: center; }
        
        .hstat {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 9px;
            font-size: 0.85rem;
        }
        
        .hstat.balance {
            background: linear-gradient(135deg, var(--green-dim), var(--bg-2));
            border-color: rgba(34,197,94,0.3);
        }
        
        .dot {
            width: 9px; height: 9px; border-radius: 50%;
            background: var(--red);
            animation: pulse 2s infinite;
        }
        .dot.on { background: var(--green); }
        
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
        
        /* â”€â”€ GRID â”€â”€ */
        .grid {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            gap: 16px;
        }
        
        .panel {
            background: var(--bg-1);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
        }
        
        .ph {
            padding: 14px 20px;
            background: var(--bg-2);
            border-bottom: 1px solid var(--border);
            font-weight: 600; font-size: 0.9rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .pc { padding: 18px; }
        
        /* â”€â”€ FORMS â”€â”€ */
        .fg { margin-bottom: 14px; }
        .fg label { display: block; margin-bottom: 5px; font-size: 0.8rem; color: var(--text-1); font-weight: 500; }
        
        .fg input, .fg select {
            width: 100%; padding: 9px 12px;
            background: var(--bg-3); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-0);
            font-family: 'IBM Plex Mono', monospace; font-size: 0.85rem;
            transition: border-color .2s;
        }
        .fg input:focus, .fg select:focus { outline: none; border-color: var(--blue); }
        
        .fr { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn {
            width: 100%; padding: 13px; border: none; border-radius: 9px;
            font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 0.95rem;
            cursor: pointer; transition: all .15s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        .btn-go { background: linear-gradient(135deg, var(--green), #16a34a); color: #fff; }
        .btn-go:hover { box-shadow: 0 0 20px var(--glow-green); transform: translateY(-1px); }
        .btn-stop { background: linear-gradient(135deg, var(--red), #e11d48); color: #fff; }
        .btn-sm { background: var(--bg-2); color: var(--text-1); border: 1px solid var(--border); }
        .btn:disabled { opacity: .45; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .exports { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-top: 14px; }
        .exports .btn { padding: 9px; font-size: 0.75rem; }
        
        /* â”€â”€ STATS â”€â”€ */
        .sg { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; margin-bottom: 16px; }
        
        .sc {
            background: var(--bg-2); padding: 14px; border-radius: 10px; text-align: center;
        }
        .sc.wide { grid-column: span 2; }
        
        .sv { font-family: 'IBM Plex Mono', monospace; font-size: 1.45rem; font-weight: 700; }
        .sv.w { color: var(--green); }
        .sv.l { color: var(--red); }
        .sl { font-size: 0.7rem; color: var(--text-1); text-transform: uppercase; letter-spacing: .6px; margin-top: 3px; }
        
        /* â”€â”€ TICK â”€â”€ */
        .tick-row {
            display: flex; align-items: center; gap: 14px;
            padding: 14px; background: var(--bg-2); border-radius: 10px; margin-bottom: 14px;
        }
        
        .big-digit {
            width: 56px; height: 56px;
            background: var(--bg-0); border-radius: 10px;
            display: grid; place-items: center;
            font-family: 'IBM Plex Mono', monospace; font-size: 1.9rem; font-weight: 700;
        }
        .big-digit.lo { color: var(--red); }
        .big-digit.hi { color: var(--green); }
        
        .tick-meta { flex: 1; }
        .tick-price { font-family: 'IBM Plex Mono', monospace; font-size: 1.05rem; font-weight: 600; }
        .tick-sub { font-size: 0.78rem; color: var(--text-1); }
        
        /* â”€â”€ PHASE â”€â”€ */
        .badge {
            padding: 5px 12px; border-radius: 6px;
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: .4px;
        }
        .badge.idle { background: var(--text-2); color: #fff; }
        .badge.observation { background: var(--blue); color: var(--bg-0); }
        .badge.trading { background: var(--green); color: var(--bg-0); }
        .badge.recovery { background: var(--red); color: #fff; }
        
        /* â”€â”€ SIGNAL â”€â”€ */
        .signal-box {
            padding: 16px; background: var(--bg-2); border-radius: 10px;
            text-align: center; margin-bottom: 14px;
        }
        .sig-dir { font-size: 1.4rem; font-weight: 700; }
        .sig-dir.over { color: var(--green); }
        .sig-dir.under { color: var(--red); }
        .sig-dir.none { color: var(--text-2); }
        .sig-sub { font-size: 0.8rem; color: var(--text-1); margin-top: 2px; }
        
        /* â”€â”€ PROGRESS â”€â”€ */
        .pbar { height: 5px; background: var(--bg-3); border-radius: 3px; overflow: hidden; margin-top: 6px; }
        .pfill { height: 100%; background: var(--blue); transition: width .3s; }
        
        /* â”€â”€ DIGITS â”€â”€ */
        .recent-row { display: flex; gap: 3px; flex-wrap: wrap; margin-bottom: 14px; }
        
        .rd {
            width: 26px; height: 26px;
            display: grid; place-items: center;
            border-radius: 4px;
            font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; font-weight: 600;
        }
        .rd.lo { background: var(--red-dim); color: var(--red); }
        .rd.hi { background: var(--green-dim); color: var(--green); }
        
        /* â”€â”€ DISTRIBUTION â”€â”€ */
        .dist { display: grid; grid-template-columns: repeat(10,1fr); gap: 4px; margin-bottom: 14px; }
        
        .dbar { display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .dbar-track { width: 100%; height: 55px; background: var(--bg-3); border-radius: 4px; position: relative; overflow: hidden; }
        .dbar-fill { position: absolute; bottom: 0; width: 100%; border-radius: 4px; transition: height .3s; }
        .dbar-fill.lo { background: var(--red); }
        .dbar-fill.hi { background: var(--green); }
        .dlbl { font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; color: var(--text-1); }
        .dpct { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; color: var(--text-2); }
        
        /* â”€â”€ TRENDS â”€â”€ */
        .tg { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; margin-bottom: 14px; }
        .tc { background: var(--bg-2); padding: 10px; border-radius: 8px; text-align: center; }
        .tv { font-family: 'IBM Plex Mono', monospace; font-size: 1.15rem; font-weight: 700; }
        .tl { font-size: 0.65rem; color: var(--text-1); margin-top: 2px; }
        
        /* â”€â”€ LOG â”€â”€ */
        .log-box {
            height: 280px; overflow-y: auto;
            font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem;
            background: var(--bg-0); border-radius: 8px; padding: 10px;
        }
        
        .le { padding: 3px 0; border-bottom: 1px solid var(--border); display: flex; gap: 8px; }
        .le-t { color: var(--text-2); min-width: 65px; }
        .le-k { min-width: 52px; font-weight: 600; }
        .le-k.info { color: var(--blue); }
        .le-k.trade { color: var(--green); }
        .le-k.loss { color: var(--red); }
        .le-k.signal { color: var(--purple); }
        .le-k.system { color: var(--amber); }
        .le-m { color: var(--text-1); flex: 1; }
        
        /* â”€â”€ SHADOW â”€â”€ */
        .sh-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 12px; }
        .sh-card { background: var(--bg-2); padding: 10px; border-radius: 7px; text-align: center; }
        .sh-v { font-family: 'IBM Plex Mono', monospace; font-size: 1.15rem; font-weight: 700; }
        .sh-l { font-size: 0.6rem; color: var(--text-1); margin-top: 2px; }
        
        .sh-row {
            display: flex; justify-content: space-between; font-size: 0.78rem;
            padding: 6px 0; border-bottom: 1px solid var(--border);
        }
        .sh-row:last-child { border: none; }
        
        /* â”€â”€ TRADES â”€â”€ */
        .th { max-height: 220px; overflow-y: auto; }
        
        .te {
            display: flex; justify-content: space-between;
            padding: 7px 10px; background: var(--bg-2); border-radius: 6px;
            margin-bottom: 5px;
            font-family: 'IBM Plex Mono', monospace; font-size: 0.73rem;
        }
        .te.win { border-left: 3px solid var(--green); }
        .te.loss { border-left: 3px solid var(--red); }
        
        /* â”€â”€ STREAK â”€â”€ */
        .streak-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 8px; margin-bottom: 10px; }
        
        /* â”€â”€ SCROLLBAR â”€â”€ */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg-2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-2); }
        
        @media (max-width: 1200px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div style="max-width:1580px; margin:0 auto;">

    <!-- HEADER -->
    <header>
        <div class="logo">
            <div class="logo-mark">Tâ†’</div>
            <h1>Trend <em>Signal</em> Bot</h1>
        </div>
        <div class="header-stats">
            <div class="hstat balance">
                <span style="color:var(--text-1)">Balance:</span>
                <span id="xBalance" class="mono" style="color:var(--green);font-weight:700;font-size:1.05rem">$0.00</span>
            </div>
            <div class="hstat">
                <div class="dot" id="xDot"></div>
                <span id="xConn">Disconnected</span>
            </div>
            <div class="hstat">
                <span>Reconnects:</span>
                <span id="xRecon" class="mono" style="color:var(--amber)">0</span>
            </div>
        </div>
    </header>

    <!-- MAIN GRID -->
    <div class="grid">

        <!-- â•â•â• LEFT: CONFIG â•â•â• -->
        <div class="panel">
            <div class="ph">Configuration</div>
            <div class="pc">
                <div class="fg">
                    <label>API Token</label>
                    <input type="password" id="cfgToken" placeholder="Deriv API token">
                </div>
                <div class="fg">
                    <label>Market</label>
                    <select id="cfgMarket">
                        <option value="R_10">Volatility 10 Index</option>
                        <option value="R_25">Volatility 25 Index</option>
                        <option value="R_50">Volatility 50 Index</option>
                        <option value="R_75">Volatility 75 Index</option>
                        <option value="R_100">Volatility 100 Index</option>
                        <option value="1HZ10V">Volatility 10 (1s)</option>
                        <option value="1HZ25V">Volatility 25 (1s)</option>
                        <option value="1HZ50V">Volatility 50 (1s)</option>
                        <option value="1HZ75V">Volatility 75 (1s)</option>
                        <option value="1HZ100V">Volatility 100 (1s)</option>
                    </select>
                </div>
                <div class="fr">
                    <div class="fg">
                        <label>Stake ($)</label>
                        <input type="number" id="cfgStake" value="0.35" min="0.35" step="0.01">
                    </div>
                    <div class="fg">
                        <label>Payout (%)</label>
                        <input type="number" id="cfgPayout" value="95" min="80" max="100">
                    </div>
                </div>
                <div class="fr">
                    <div class="fg">
                        <label>Observation Ticks</label>
                        <input type="number" id="cfgObs" value="100" min="10" max="500" step="10">
                    </div>
                    <div class="fg">
                        <label>Consec. Trigger</label>
                        <input type="number" id="cfgTrigger" value="6" min="2" max="10">
                    </div>
                </div>
                <div class="fr">
                    <div class="fg">
                        <label>Stop Loss ($)</label>
                        <input type="number" id="cfgSL" value="0" min="0" step="5" placeholder="0 = off">
                    </div>
                    <div class="fg">
                        <label>Take Profit ($)</label>
                        <input type="number" id="cfgTP" value="0" min="0" step="5" placeholder="0 = off">
                    </div>
                </div>
                
                <div class="fg">
                    <label>Session Limit (trades)</label>
                    <input type="number" id="cfgMaxTrades" value="0" min="0" step="10" placeholder="0 = unlimited">
                    <div style="font-size:.68rem;color:var(--text-2);margin-top:3px;">Auto-stop after N trades (0 = run forever)</div>
                </div>

                <button class="btn btn-go" id="btnStart">â–¶ Start Bot</button>
                <button class="btn btn-stop" id="btnStop" style="display:none;margin-top:10px;">â–  Stop Bot</button>

                <div class="exports">
                    <button class="btn btn-sm" id="btnExpTicks">Ticks CSV</button>
                    <button class="btn btn-sm" id="btnExpTrades">Trades CSV</button>
                    <button class="btn btn-sm" id="btnExpLog">Log CSV</button>
                </div>
            </div>
        </div>

        <!-- â•â•â• CENTER: DASHBOARD â•â•â• -->
        <div style="display:flex;flex-direction:column;gap:16px;">

            <!-- Status & Stats -->
            <div class="panel">
                <div class="ph">
                    <span>Trading Status</span>
                    <div class="badge idle" id="xPhase">IDLE</div>
                </div>
                <div class="pc">
                    <div style="margin-bottom:14px;">
                        <div style="font-size:.78rem;color:var(--text-1)">Observation Progress</div>
                        <div class="mono" style="font-size:1rem;" id="xObsProg">0 / 100</div>
                        <div class="pbar"><div class="pfill" id="xObsFill" style="width:0%"></div></div>
                    </div>

                    <div class="tick-row">
                        <div class="big-digit" id="xDigit">-</div>
                        <div class="tick-meta">
                            <div class="tick-price" id="xPrice">0.00000</div>
                            <div class="tick-sub">Tick #<span id="xTickN">0</span></div>
                        </div>
                    </div>

                    <div class="sg">
                        <div class="sc"><div class="sv" id="xTotalT">0</div><div class="sl">Trades</div></div>
                        <div class="sc"><div class="sv" id="xWinR">0%</div><div class="sl">Win Rate</div></div>
                        <div class="sc"><div class="sv" id="xWins">0</div><div class="sl">Wins</div></div>
                        <div class="sc"><div class="sv" id="xLosses">0</div><div class="sl">Losses</div></div>
                        <div class="sc wide"><div class="sv w" id="xPL">$0.00</div><div class="sl">Profit / Loss</div></div>
                    </div>

                    <div class="signal-box">
                        <div class="sig-dir none" id="xSigDir">WAITING</div>
                        <div class="sig-sub" id="xSigSub">Collecting dataâ€¦</div>
                    </div>

                    <div style="font-size:.78rem;color:var(--text-1);margin-bottom:6px;">Recent Digits (30)</div>
                    <div class="recent-row" id="xRecent"></div>
                </div>
            </div>

            <!-- Pattern Analysis -->
            <div class="panel">
                <div class="ph">Pattern Analysis</div>
                <div class="pc">
                    <div style="font-size:.78rem;color:var(--text-1);margin-bottom:6px;">Digit Distribution</div>
                    <div class="dist" id="xDist"></div>

                    <div class="tg">
                        <div class="tc"><div class="tv" id="xLoPct">50%</div><div class="tl">Low (0â€“4)</div></div>
                        <div class="tc"><div class="tv" id="xHiPct">50%</div><div class="tl">High (5â€“9)</div></div>
                        <div class="tc"><div class="tv" id="xCLo">0</div><div class="tl">Consec Low</div></div>
                        <div class="tc"><div class="tv" id="xCHi">0</div><div class="tl">Consec High</div></div>
                    </div>
                </div>
            </div>

            <!-- Log -->
            <div class="panel">
                <div class="ph">
                    <span>Activity Log</span>
                    <button class="btn btn-sm" style="width:auto;padding:5px 12px;font-size:.7rem;" id="btnClearLog">Clear</button>
                </div>
                <div class="pc">
                    <div class="log-box" id="xLog"></div>
                </div>
            </div>
        </div>

        <!-- â•â•â• RIGHT: SHADOW & HISTORY â•â•â• -->
        <div style="display:flex;flex-direction:column;gap:16px;">

            <!-- Shadow Tracker -->
            <div class="panel">
                <div class="ph">
                    <span>Shadow Performance</span>
                    <button class="btn btn-sm" style="width:auto;padding:5px 10px;font-size:.7rem;" id="btnResetSh">Reset</button>
                </div>
                <div class="pc">
                    <div style="padding:10px;border-radius:8px;text-align:center;margin-bottom:12px;background:var(--bg-2);">
                        <div style="font-size:.68rem;color:var(--text-1);margin-bottom:3px;">SIGNAL PERFORMANCE</div>
                        <div id="xShRec" style="font-size:1.05rem;font-weight:700;color:var(--text-2);">COLLECTINGâ€¦</div>
                    </div>
                    
                    <div class="sh-grid">
                        <div class="sh-card"><div class="sh-v" style="color:var(--green)" id="xShW">0</div><div class="sh-l">WINS</div></div>
                        <div class="sh-card"><div class="sh-v" style="color:var(--red)" id="xShL">0</div><div class="sh-l">LOSSES</div></div>
                        <div class="sh-card"><div class="sh-v" id="xShD">0</div><div class="sh-l">DIFF</div></div>
                    </div>

                    <div style="background:var(--bg-2);padding:10px;border-radius:7px;margin-bottom:12px;">
                        <div class="sh-row">
                            <span style="color:var(--text-1)">Win Rate:</span>
                            <span class="mono" id="xShWR">â€“</span>
                        </div>
                        <div class="sh-row">
                            <span style="color:var(--text-1)">Last Signal:</span>
                            <span class="mono" id="xShSig">â€“</span>
                        </div>
                        <div class="sh-row">
                            <span style="color:var(--text-1)">Last Result:</span>
                            <span class="mono" id="xShRes">â€“</span>
                        </div>
                    </div>
                    
                    <!-- Streak Monitor -->
                    <div style="border-top:1px solid var(--border);padding-top:12px;">
                        <div style="font-weight:600;font-size:.82rem;margin-bottom:8px;">Loss Streak Monitor</div>
                        <div class="streak-grid">
                            <div class="sh-card">
                                <div class="sh-v" id="xCurStrk">0</div>
                                <div class="sh-l">CURRENT</div>
                            </div>
                            <div class="sh-card">
                                <div class="sh-v" style="color:var(--red)" id="xMaxStrk">0</div>
                                <div class="sh-l">MAX STREAK</div>
                            </div>
                        </div>
                        <div style="background:var(--bg-2);padding:10px;border-radius:7px;">
                            <div class="sh-row">
                                <span style="color:var(--text-1)">Total Cycles:</span>
                                <span class="mono" id="xCycles">0</span>
                            </div>
                            <div class="sh-row">
                                <span style="color:var(--text-1)">4+ Streaks:</span>
                                <span class="mono" style="color:var(--red)" id="xBadStrk">0</span>
                            </div>
                            <div class="sh-row">
                                <span style="color:var(--text-1)">Streak Rate:</span>
                                <span class="mono" id="xStrkRate">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade History -->
            <div class="panel">
                <div class="ph">Trade History</div>
                <div class="pc">
                    <div class="th" id="xHistory">
                        <div style="text-align:center;color:var(--text-2);padding:20px;">No trades yet</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
    ws: null,
    connected: false,
    reconAttempts: 0,
    reconTimer: null,
    keepAlive: null,
    lastPing: null,
    
    running: false,
    phase: 'idle',  // idle | observation | trading | recovery
    direction: null,
    
    // Shadow tracker (passive performance monitor)
    shadow: {
        wins: 0, losses: 0, diff: 0,
        cLo: 0, cHi: 0,
        lastSig: null, lastRes: null,
        pending: null, pendingEval: null,
        curStreak: 0, maxStreak: 0,
        cycles: 0, badStreaks: 0,
        history: []
    },
    
    ticks: [],
    digits: [],
    dCounts: new Array(10).fill(0),
    trades: [],
    logs: [],
    
    total: 0, wins: 0, losses: 0, pnl: 0,
    cLo: 0, cHi: 0,
    
    cfg: {
        token: '', market: 'R_10', stake: 0.35, payout: 95,
        obs: 100, trigger: 6, sl: 0, tp: 0, maxTrades: 0
    },
    
    contractId: null,
    pendingTrade: null
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let db = null;

async function initDB() {
    return new Promise((res, rej) => {
        const r = indexedDB.open('TrendBot', 1);
        r.onerror = () => rej(r.error);
        r.onsuccess = () => { db = r.result; res(db); };
        r.onupgradeneeded = e => {
            const d = e.target.result;
            if (!d.objectStoreNames.contains('ticks')) d.createObjectStore('ticks', { keyPath: 'id', autoIncrement: true });
            if (!d.objectStoreNames.contains('trades')) d.createObjectStore('trades', { keyPath: 'id', autoIncrement: true });
            if (!d.objectStoreNames.contains('state')) d.createObjectStore('state', { keyPath: 'key' });
        };
    });
}

function dbSave(store, data) {
    if (!db) return;
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).add(data);
}

function dbState() {
    if (!db) return;
    const tx = db.transaction('state', 'readwrite');
    tx.objectStore('state').put({ key: 'appState', value: { pnl: S.pnl, wins: S.wins, losses: S.losses, total: S.total } });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $log = document.getElementById('xLog');

function log(type, msg) {
    const t = new Date().toTimeString().slice(0, 8);
    S.logs.push({ timestamp: new Date().toISOString(), type, message: msg });
    
    const el = document.createElement('div');
    el.className = 'le';
    el.innerHTML = `<span class="le-t">${t}</span><span class="le-k ${type}">${type.toUpperCase()}</span><span class="le-m">${msg}</span>`;
    $log.insertBefore(el, $log.firstChild);
    
    while ($log.children.length > 200) $log.removeChild($log.lastChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connect() {
    if (S.ws && S.ws.readyState === WebSocket.OPEN) return;
    
    log('system', 'Connectingâ€¦');
    S.ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
    
    S.ws.onopen = () => {
        S.connected = true;
        S.reconAttempts = 0;
        setConn(true);
        log('system', 'Connected');
        if (S.cfg.token) send({ authorize: S.cfg.token });
        startKA();
    };
    
    S.ws.onclose = () => {
        S.connected = false;
        setConn(false);
        log('system', 'Disconnected');
        stopKA();
        schedRecon();
    };
    
    S.ws.onerror = () => log('system', 'WebSocket error');
    S.ws.onmessage = e => handle(JSON.parse(e.data));
}

function send(d) { if (S.ws?.readyState === WebSocket.OPEN) S.ws.send(JSON.stringify(d)); }

function setConn(on) {
    document.getElementById('xDot').classList.toggle('on', on);
    document.getElementById('xConn').textContent = on ? 'Connected' : 'Disconnected';
}

function schedRecon() {
    if (S.reconTimer) return;
    const delay = Math.min(1000 * 2 ** S.reconAttempts, 30000);
    S.reconAttempts++;
    document.getElementById('xRecon').textContent = S.reconAttempts;
    log('system', `Reconnect in ${delay/1000}s (#${S.reconAttempts})`);
    S.reconTimer = setTimeout(() => { S.reconTimer = null; connect(); }, delay);
}

function startKA() {
    stopKA();
    S.keepAlive = setInterval(() => {
        if (S.connected) {
            send({ ping: 1 });
            S.lastPing = Date.now();
            setTimeout(() => {
                if (S.lastPing && Date.now() - S.lastPing > 20000) {
                    log('system', 'Stale connection, reconnectingâ€¦');
                    S.ws.close();
                }
            }, 15000);
        }
    }, 15000);
}

function stopKA() { if (S.keepAlive) { clearInterval(S.keepAlive); S.keepAlive = null; } }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGE HANDLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handle(d) {
    if (d.error) { log('system', `Error: ${d.error.message}`); return; }
    
    if (d.msg_type === 'authorize') {
        log('system', 'Authorized');
        send({ balance: 1, subscribe: 1 });
        subTicks();
    }
    if (d.msg_type === 'balance') {
        document.getElementById('xBalance').textContent = `$${parseFloat(d.balance.balance).toFixed(2)}`;
    }
    if (d.msg_type === 'tick') onTick(d.tick);
    if (d.msg_type === 'buy') onBuy(d);
    if (d.msg_type === 'proposal_open_contract') onContract(d.proposal_open_contract);
    if (d.msg_type === 'ping') S.lastPing = null;
}

function subTicks() {
    send({ ticks: S.cfg.market, subscribe: 1 });
    log('info', `Subscribed: ${S.cfg.market}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICK PROCESSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onTick(tick) {
    const price = parseFloat(tick.quote);
    const digit = parseInt(price.toString().slice(-1));
    
    const td = { timestamp: new Date(tick.epoch * 1000).toISOString(), price, digit, epoch: tick.epoch };
    S.ticks.push(td);
    dbSave('ticks', td);
    if (S.ticks.length > 5000) S.ticks.shift();
    
    S.digits.push(digit);
    S.dCounts[digit]++;
    if (S.digits.length > 1000) { S.dCounts[S.digits.shift()]--; }
    
    // Consecutive counters
    if (digit <= 4) { S.cLo++; S.cHi = 0; }
    else { S.cHi++; S.cLo = 0; }
    
    // UI updates
    uiTick(price, digit);
    uiDist();
    uiRecent();
    uiTrend();
    uiObs();
    
    // Shadow tracker (always runs)
    runShadow(digit);
    
    // Trading logic
    if (S.running) processTrade(digit);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHADOW TRACKER (passive monitor)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runShadow(digit) {
    const sh = S.shadow;
    
    if (digit <= 4) { sh.cLo++; sh.cHi = 0; }
    else { sh.cHi++; sh.cLo = 0; }
    
    if (S.digits.length < S.cfg.obs) { uiShadow(); return; }
    
    const trigger = S.cfg.trigger;
    let sig = null;
    
    // Trend-following: consecutive lows â†’ under, consecutive highs â†’ over
    if (sh.cLo >= trigger) sig = 'under';
    else if (sh.cHi >= trigger) sig = 'over';
    
    // Queue signal for next-tick evaluation
    if (sig && sh.pending === null) {
        sh.pending = { direction: sig, idx: S.digits.length };
        sh.lastSig = sig;
    }
    
    // Evaluate previous pending
    if (sh.pendingEval) {
        const ev = sh.pendingEval;
        const won = (ev.direction === 'over' && digit >= 5) || (ev.direction === 'under' && digit <= 4);
        
        if (won) {
            sh.wins++;
            sh.lastRes = 'WON âœ“';
            sh.cycles++;
            if (sh.curStreak >= 4) sh.badStreaks++;
            sh.curStreak = 0;
        } else {
            sh.losses++;
            sh.lastRes = 'LOST âœ—';
            sh.curStreak++;
            if (sh.curStreak > sh.maxStreak) sh.maxStreak = sh.curStreak;
        }
        
        sh.diff = sh.wins - sh.losses;
        sh.history.push({ direction: ev.direction, won, diff: sh.diff });
        sh.pendingEval = null;
    }
    
    // Move pending â†’ eval
    if (sh.pending) {
        sh.pendingEval = sh.pending;
        sh.pending = null;
    }
    
    uiShadow();
}

function resetShadow() {
    const sh = S.shadow;
    sh.wins = sh.losses = sh.diff = sh.cLo = sh.cHi = 0;
    sh.curStreak = sh.maxStreak = sh.cycles = sh.badStreaks = 0;
    sh.lastSig = sh.lastRes = null;
    sh.pending = sh.pendingEval = null;
    sh.history = [];
    uiShadow();
    log('system', 'Shadow tracker reset');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADING LOGIC â€” SIMPLE & DIRECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processTrade(digit) {
    const obsCount = Math.min(S.digits.length, S.cfg.obs);
    
    switch (S.phase) {
        case 'observation':
            if (obsCount >= S.cfg.obs) {
                S.phase = 'trading';
                setPhase('trading');
                log('info', 'âœ… Observation complete â€” trading every signal');
            }
            break;
            
        case 'trading':
            const sig = getSignal();
            if (sig) {
                S.direction = sig.direction;
                uiSignal(sig);
                log('signal', `${sig.direction.toUpperCase()} â€” ${sig.reason}`);
                placeTrade();
            }
            break;
            
        case 'recovery':
            // Waiting for contract result
            break;
    }
}

function getSignal() {
    const trigger = S.cfg.trigger;
    
    // Trend-following only: consecutive pattern â†’ continue direction
    if (S.cLo >= trigger) {
        return { direction: 'under', reason: `${S.cLo} consecutive lows â†’ trend UNDER` };
    }
    if (S.cHi >= trigger) {
        return { direction: 'over', reason: `${S.cHi} consecutive highs â†’ trend OVER` };
    }
    
    return null;
}

function placeTrade() {
    const stake = S.cfg.stake;
    const barrier = S.direction === 'over' ? '4' : '5';
    const type = S.direction === 'over' ? 'DIGITOVER' : 'DIGITUNDER';
    
    S.pendingTrade = {
        direction: S.direction,
        stake,
        timestamp: new Date().toISOString()
    };
    
    S.phase = 'recovery';  // Wait for result
    setPhase('recovery');
    
    log('trade', `${S.direction.toUpperCase()} $${stake.toFixed(2)}`);
    
    send({
        buy: 1,
        price: stake,
        parameters: {
            contract_type: type,
            symbol: S.cfg.market,
            duration: 1,
            duration_unit: 't',
            basis: 'stake',
            amount: stake,
            currency: 'USD',
            barrier
        }
    });
}

function onBuy(data) {
    if (data.buy) {
        S.contractId = data.buy.contract_id;
        log('info', `Contract: ${S.contractId}`);
        send({ proposal_open_contract: 1, contract_id: S.contractId, subscribe: 1 });
    }
}

function onContract(c) {
    if (!c.is_sold) return;
    
    const won = c.status === 'won';
    const profit = parseFloat(c.profit);
    
    S.total++;
    S.pnl += profit;
    
    const trade = { ...S.pendingTrade, won, profit, balance: S.pnl, contractId: c.contract_id };
    S.trades.push(trade);
    dbSave('trades', trade);
    dbState();
    
    if (won) {
        S.wins++;
        log('trade', `WIN +$${profit.toFixed(2)} | Total: $${S.pnl.toFixed(2)}`);
    } else {
        S.losses++;
        log('loss', `LOSS $${profit.toFixed(2)} | Total: $${S.pnl.toFixed(2)}`);
    }
    
    // Back to scanning for next signal
    S.phase = 'trading';
    setPhase('trading');
    S.direction = null;
    
    uiStats();
    uiTradeEntry(trade);
    
    // Check limits
    if (S.cfg.sl > 0 && S.pnl <= -S.cfg.sl) {
        log('system', `â›” Stop loss hit ($${S.pnl.toFixed(2)})`);
        stopBot();
        return;
    }
    if (S.cfg.tp > 0 && S.pnl >= S.cfg.tp) {
        log('system', `ğŸ¯ Take profit hit ($${S.pnl.toFixed(2)})`);
        stopBot();
        return;
    }
    if (S.cfg.maxTrades > 0 && S.total >= S.cfg.maxTrades) {
        log('system', `ğŸ“Š Session limit reached (${S.total} trades)`);
        stopBot();
        return;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI UPDATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uiTick(price, digit) {
    document.getElementById('xPrice').textContent = price.toFixed(5);
    const el = document.getElementById('xDigit');
    el.textContent = digit;
    el.className = 'big-digit ' + (digit <= 4 ? 'lo' : 'hi');
    document.getElementById('xTickN').textContent = S.ticks.length;
}

function uiObs() {
    const n = Math.min(S.digits.length, S.cfg.obs);
    document.getElementById('xObsProg').textContent = `${n} / ${S.cfg.obs}`;
    document.getElementById('xObsFill').style.width = `${Math.min(n / S.cfg.obs * 100, 100)}%`;
}

function uiDist() {
    const total = S.digits.length || 1;
    let h = '';
    for (let i = 0; i < 10; i++) {
        const pct = S.dCounts[i] / total * 100;
        const hPct = Math.min(pct * 5, 100);
        h += `<div class="dbar">
            <div class="dbar-track"><div class="dbar-fill ${i<=4?'lo':'hi'}" style="height:${hPct}%"></div></div>
            <div class="dlbl">${i}</div>
            <div class="dpct">${pct.toFixed(1)}%</div>
        </div>`;
    }
    document.getElementById('xDist').innerHTML = h;
}

function uiRecent() {
    const r = S.digits.slice(-30);
    document.getElementById('xRecent').innerHTML = r.map(d =>
        `<div class="rd ${d<=4?'lo':'hi'}">${d}</div>`
    ).join('');
}

function uiTrend() {
    const r = S.digits.slice(-100);
    const lo = r.filter(d => d <= 4).length;
    const t = r.length || 1;
    document.getElementById('xLoPct').textContent = `${(lo/t*100).toFixed(1)}%`;
    document.getElementById('xHiPct').textContent = `${((t-lo)/t*100).toFixed(1)}%`;
    document.getElementById('xCLo').textContent = S.cLo;
    document.getElementById('xCHi').textContent = S.cHi;
}

function uiStats() {
    document.getElementById('xTotalT').textContent = S.total;
    document.getElementById('xWins').textContent = S.wins;
    document.getElementById('xLosses').textContent = S.losses;
    document.getElementById('xWinR').textContent = S.total ? `${(S.wins/S.total*100).toFixed(1)}%` : '0%';
    
    const el = document.getElementById('xPL');
    el.textContent = `$${S.pnl.toFixed(2)}`;
    el.className = `sv ${S.pnl >= 0 ? 'w' : 'l'}`;
}

function uiSignal(sig) {
    if (sig) {
        document.getElementById('xSigDir').textContent = sig.direction.toUpperCase();
        document.getElementById('xSigDir').className = `sig-dir ${sig.direction}`;
        document.getElementById('xSigSub').textContent = sig.reason;
    } else {
        document.getElementById('xSigDir').textContent = 'SCANNING';
        document.getElementById('xSigDir').className = 'sig-dir none';
        document.getElementById('xSigSub').textContent = 'Waiting for trend signalâ€¦';
    }
}

function uiTradeEntry(trade) {
    const box = document.getElementById('xHistory');
    if (S.trades.length === 1) box.innerHTML = '';
    
    const el = document.createElement('div');
    el.className = `te ${trade.won ? 'win' : 'loss'}`;
    el.innerHTML = `<span>${trade.direction.toUpperCase()}</span><span>${trade.won?'+':''}$${trade.profit.toFixed(2)}</span>`;
    box.insertBefore(el, box.firstChild);
    while (box.children.length > 50) box.removeChild(box.lastChild);
}

function uiShadow() {
    const sh = S.shadow;
    
    document.getElementById('xShW').textContent = sh.wins;
    document.getElementById('xShL').textContent = sh.losses;
    
    const dEl = document.getElementById('xShD');
    dEl.textContent = (sh.diff >= 0 ? '+' : '') + sh.diff;
    dEl.style.color = sh.diff >= 0 ? 'var(--green)' : 'var(--red)';
    
    const total = sh.wins + sh.losses;
    document.getElementById('xShWR').textContent = total ? `${(sh.wins/total*100).toFixed(1)}%` : 'â€“';
    
    const sigEl = document.getElementById('xShSig');
    if (sh.lastSig) {
        sigEl.textContent = sh.lastSig.toUpperCase();
        sigEl.style.color = sh.lastSig === 'over' ? 'var(--green)' : 'var(--red)';
    }
    
    const resEl = document.getElementById('xShRes');
    if (sh.lastRes) {
        resEl.textContent = sh.lastRes;
        resEl.style.color = sh.lastRes.includes('WON') ? 'var(--green)' : 'var(--red)';
    }
    
    // Performance indicator
    const rec = document.getElementById('xShRec');
    if (total < 10) {
        rec.textContent = `COLLECTINGâ€¦ (${total}/10)`;
        rec.style.color = 'var(--text-2)';
    } else {
        const wr = (sh.wins / total * 100).toFixed(1);
        rec.textContent = `${wr}% WIN RATE (${total} signals)`;
        rec.style.color = parseFloat(wr) >= 52 ? 'var(--green)' : parseFloat(wr) >= 48 ? 'var(--amber)' : 'var(--red)';
    }
    
    // Streak
    document.getElementById('xCurStrk').textContent = sh.curStreak;
    document.getElementById('xMaxStrk').textContent = sh.maxStreak;
    document.getElementById('xCycles').textContent = sh.cycles;
    document.getElementById('xBadStrk').textContent = sh.badStreaks;
    
    const rate = sh.cycles ? ((sh.badStreaks / sh.cycles) * 100).toFixed(1) : '0.0';
    const rEl = document.getElementById('xStrkRate');
    rEl.textContent = rate + '%';
    rEl.style.color = parseFloat(rate) > 5 ? 'var(--red)' : parseFloat(rate) > 3 ? 'var(--amber)' : 'var(--green)';
    
    const csEl = document.getElementById('xCurStrk');
    csEl.style.color = sh.curStreak >= 4 ? 'var(--red)' : sh.curStreak >= 2 ? 'var(--amber)' : 'var(--text-0)';
}

function setPhase(p) {
    S.phase = p;
    const el = document.getElementById('xPhase');
    el.className = `badge ${p}`;
    el.textContent = p.toUpperCase();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startBot() {
    S.cfg.token = document.getElementById('cfgToken').value;
    S.cfg.market = document.getElementById('cfgMarket').value;
    S.cfg.stake = parseFloat(document.getElementById('cfgStake').value);
    S.cfg.payout = parseFloat(document.getElementById('cfgPayout').value);
    S.cfg.obs = parseInt(document.getElementById('cfgObs').value);
    S.cfg.trigger = parseInt(document.getElementById('cfgTrigger').value);
    S.cfg.sl = parseFloat(document.getElementById('cfgSL').value) || 0;
    S.cfg.tp = parseFloat(document.getElementById('cfgTP').value) || 0;
    S.cfg.maxTrades = parseInt(document.getElementById('cfgMaxTrades').value) || 0;
    
    if (!S.cfg.token) { log('system', 'Enter API token'); return; }
    
    S.running = true;
    S.phase = 'observation';
    S.direction = null;
    S.digits = [];
    S.cLo = S.cHi = 0;
    
    resetShadow();
    setPhase('observation');
    uiObs();
    uiSignal(null);
    
    document.getElementById('btnStart').style.display = 'none';
    document.getElementById('btnStop').style.display = 'block';
    
    log('system', 'â–¶ Bot started â€” trend-following, flat bet, every signal');
    log('info', `Stake: $${S.cfg.stake} | Trigger: ${S.cfg.trigger} consec | Obs: ${S.cfg.obs} ticks`);
    if (S.cfg.maxTrades > 0) log('info', `Session limit: ${S.cfg.maxTrades} trades`);
    if (S.cfg.sl > 0) log('info', `Stop loss: $${S.cfg.sl}`);
    if (S.cfg.tp > 0) log('info', `Take profit: $${S.cfg.tp}`);
    
    if (!S.connected) connect();
    else subTicks();
    
    reqWL();
}

function stopBot() {
    S.running = false;
    S.phase = 'idle';
    setPhase('idle');
    
    document.getElementById('btnStart').style.display = 'block';
    document.getElementById('btnStop').style.display = 'none';
    
    log('system', `â–  Bot stopped | ${S.total} trades | $${S.pnl.toFixed(2)}`);
    dbState();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAKE LOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let wakeLock = null;

async function reqWL() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            log('system', 'Wake lock acquired');
            wakeLock.addEventListener('release', () => log('system', 'Wake lock released'));
        }
    } catch(e) { log('system', `Wake lock: ${e.message}`); }
}

document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible' && S.running) {
        await reqWL();
        if (!S.connected) { log('system', 'Reconnectingâ€¦'); connect(); }
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(data, filename, headers) {
    const csv = [
        headers.join(','),
        ...data.map(row => headers.map(h => {
            const v = row[h.toLowerCase().replace(/ /g, '')];
            return typeof v === 'string' && v.includes(',') ? `"${v}"` : v;
        }).join(','))
    ].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENT LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btnStart').addEventListener('click', startBot);
document.getElementById('btnStop').addEventListener('click', stopBot);
document.getElementById('btnClearLog').addEventListener('click', () => {
    $log.innerHTML = '';
    S.logs = [];
    log('system', 'Log cleared');
});
document.getElementById('btnResetSh').addEventListener('click', resetShadow);

document.getElementById('btnExpTicks').addEventListener('click', () => {
    exportCSV(S.ticks, `ticks_${Date.now()}.csv`, ['timestamp','price','digit','epoch']);
    log('system', `Exported ${S.ticks.length} ticks`);
});
document.getElementById('btnExpTrades').addEventListener('click', () => {
    exportCSV(S.trades, `trades_${Date.now()}.csv`, ['timestamp','direction','stake','won','profit','balance']);
    log('system', `Exported ${S.trades.length} trades`);
});
document.getElementById('btnExpLog').addEventListener('click', () => {
    exportCSV(S.logs, `log_${Date.now()}.csv`, ['timestamp','type','message']);
    log('system', `Exported ${S.logs.length} log entries`);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
    await initDB();
    uiDist();
    uiShadow();
    log('system', 'Trend Signal Bot initialized');
    log('info', 'Strategy: Trade EVERY trend signal with flat stake');
    log('info', 'No snipe, no autopilot, no martingale â€” pure volume at edge');
}

init();
</script>
</body>
</html>
